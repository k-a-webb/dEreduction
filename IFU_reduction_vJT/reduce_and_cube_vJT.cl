# Origanlly written by Bryan Miller and reduction steps by Gwen Rudie
# Edited by Kristi Webb May 2015

## 2005dec03
#GN-2005B-DD-5-3    16:20:39    1         239           Twilight    g        B600/478.0  IFU        300            full
#GN-2005B-DD-5-3    not quite enough counts, redo junk
#GN-2005B-DD-5-3    16:29:20    2         240           Twilight    g        B600/478.0  IFU        400            full
#GN-2005B-DD-5-3    35000 cts max ok
#GN-2005B-DD-5-3    16:38:00    3         241           Twilight    g        B600/482    IFU        120            full

## 2005dec04
#GN-CAL20051204-3  16:56:25    11-15      227-231       Bias         none     mirror     none  0.0            full

## 2005dec05
#GN-2005B-DD-5-2   04:28:42    1          1             IC225        g        mirror      none       10.0           ccd2
#   p=27.6 q=-2.01
#GN-2005B-DD-5-2   04:33:08    2          2             IC225        g        mirror      IFU        60             full
#   p=0.875, q=-0.33
#GN-2005B-DD-5-2   04:39:37    3          3             IC225        g        mirror      IFU        60             full
#   centered on the midpoint btw the 2 nuclei
#GN-2005B-DD-5-1   04:43:50    1-2        4-5           CuAr         g        B600/478.0  IFU        120.0          full
#   Junk
#GN-2005B-DD-5-1   04:52:05    3          6             IC225        g        B600/478.0  IFU        3300.0         full
#   ok
#GN-2005B-DD-5-1   05:49:52    4          7             GCALflat     g        B600/478.0  IFU        40.0           full
#   ok
#GN-2005B-DD-5-1   05:52:12    5          8             CuAr         g        B600/478.0  IFU        120.0          full
#   ok

## 2005dec06
#GN-2005B-DD-5-4   11:51:59    1          124           Hiltner600   g        mirror      none       1              ccd2
#   testing seeing (unable to guide with guide star, switched to the brighter target for test)
#   ok
#GN-2005B-DD-5-4   11:55:34    2-3        125-126       Hiltner600   g        mirror      none       10             ccd2
#   ok
#   starting acquistion (guiding on correct star)
#GN-2005B-DD-5-4   12:05:49    4          127           Hiltner600   g        mirror      IFU        2              full
#   ok
#GN-2005B-DD-5-4   12:12:00    5-7        128-130       Hiltner600   g        mirror      IFU        2              full
#   ok
#   do not see  lower fiber bundle, but have centered star
#GN-2005B-DD-5-5   12:21:23    1-2        131-132       Hiltner600   g        B600/478.0  IFU        160.0          full
#   junk, lost guiding
#   ok, exptime 160
#GN-2005B-DD-5-5   12:36:39    3          133           Hiltner600   g        B600/478.0  IFU        300            full
#   ok, exptime 300
#GN-2005B-DD-5-5   12:46:42    4          134           Hiltner600   g        B600/478.0  IFU        400            full
#   ok, exptime 400
#GN-2005B-DD-5-5   12:56:10    5          135           GCALflat     g        B600/478.0  IFU        40.0           full
#   ok
#GN-2005B-DD-5-6   13:23:30    1          136           Hiltner600   g        mirror      none       10             ccd2
#   ok
#GN-2005B-DD-5-5   14:37:12    6          138           CuAr         g        B600/478.0  IFU        120.0          full
#   ok

## 2005dec20
#GN-CAL20051220-6  16:36:44    11-15      228-232       Bias         none     mirror      none       0.0            full

## 2005dec22
#GN-2005B-DD-5-2   06:42:26    4          103           IC225        g        mirror      none       10.0           ccd2
#GN-2005B-DD-5-2   06:51:19    5          104           IC225        g        mirror      IFU        60             full
#GN-2005B-DD-5-2   06:55:33    6          105           IC225        g        mirror      IFU        60             full
#GN-2005B-DD-5-1   06:59:30    6          106           CuAr         g        B600/482.0  IFU        120.0          full
#GN-2005B-DD-5-1   07:02:58    7          107           GCALflat     g        B600/482.0  IFU        40.0           full
#GN-2005B-DD-5-1   07:05:16    8          108           IC225        g        B600/482.0  IFU        3300.0         full
#GN-2005B-DD-5-1   08:01:54    9          109           CuAr         g        B600/482.0  IFU        120.0          full
#GN-2005B-DD-5-1   08:05:36    10-11      110-111       CuAr         g        B600/478.0  IFU        120.0          full
#GN-2005B-DD-5-1   08:12:35    12         112           IC225        g        B600/478.0  IFU        3300.0         full
#GN-2005B-DD-5-1   09:09:13    13         113           GCALflat     g        B600/478.0  IFU        40.0           full
#GN-2005B-DD-5-1   09:11:21    14         114           CuAr         g        B600/478.0  IFU        120.0          full

## 2005dec23
#GN-2005B-DD-5-2  06:42:20    7           116           IC225        g        mirror      none       10.0           ccd2
#GN-2005B-DD-5-2  06:57:01    8           117           IC225        g        mirror      IFU        60             full
#GN-2005B-DD-5-2  07:02:47    9           118           IC225        g        mirror      IFU        60             full

##Entries for images 119-122 missing, added manually from headers
#GN-2005B-DD-5-1   07:07:36    15         119           CuAr         g        B600/482.0  IFU        120.0          full
#GN-2005B-DD-5-1   07:11:04    16         120           GCALflat     g        B600/482.0  IFU        40.0           full
#GN-2005B-DD-5-1   07:13:23    17         121           IC225        g        B600/482.0  IFU        3300.0         full
#GN-2005B-DD-5-1   08:10:01    18         122           CuAr         g        B600/482.0  IFU        120.0          full


## Aliases
## -------
set dd5=/Users/kwebb/IFU_reduction/proc
set caldir=dd5$calib/
set rawdir=/net/sbfmaps/Volumes/Science/bmiller/bdisk/bmiller/GN-2005B-DD-5/raw/

set mygmos=/Users/kwebb/iraf/scripts/gmos/
set kgmos=/Users/kwebb/iraf/scripts/
set jgmos=/Users/kwebb/iraf/extern/ifudrgmos/gmos/
directory.nc=1
set stdimage=imtgmos

reset gemini = /Users/kwebb/iraf/extern/ifudrgmos/
#task gemifudr.pkg = gemini$gemini.cl
redefine gemini.pkg = gemini$gemini.cl

# in pyraf
reset pyfu = "/Users/kwebb/iraf/extern/pyfu-0.8.1/"  # remember the trailing slash!
task pyfu.pkg = pyfu$pyfu.cl

## Scripts
## -------
rv
onedspec
gemini
gmos
pyfu

task mkmbpm=mygmos$mkmbpm.cl                # no standard
task gfshift=mygmos$gfshift.cl              # no standard
task gkeywpars=mygmos$gkeywpars.cl
task gfxcor=mygmos$gfxcor.cl
task ifuproc_gqecorr=mygmos$ifuproc_gqecorr.cl      #### TO USE James' gfresponse include parameter wavtraname, remove if using IRAF std. task

task gscombine=kgmos$gscombine.cl
task align_cubes=kgmos$align_cubes.cl
task make_cube=kgmos$make_cube.cl
task scrop=kgmos$scrop.cl
#task gmosaic=kgmos$gmosaic.cl
#task gfextract=kgmos$gfextract.cl

# Set one-off parameters reproducibly:
gfreduce.slits="both"
#gfreduce.exslits="*"
gfreduce.fl_nodshuffl=no
gfreduce.fl_inter=no
gfreduce.fl_vardq=yes
gfreduce.fl_addmdf=no
gfreduce.fl_over=no
gfreduce.fl_trim=no
gfreduce.fl_bias=no
#gfreduce.fl_qecorr=no                      # not yet implemented
gfreduce.fl_gscrrej=no
gfreduce.fl_gnsskysub=no
gfreduce.fl_extract=yes
gfreduce.fl_gsappwave=yes
gfreduce.fl_wavtran=yes
gfreduce.fl_skysub=no
gfreduce.fl_fluxcal=no
gfreduce.rawpath="rawdir$"
gfreduce.key_mdf=""
gfreduce.mdffile="default"
gfreduce.mdfdir="gmos$data/"
gfreduce.key_biassec="BIASSEC"
gfreduce.key_datasec="DATASEC"
gfreduce.bpmfile="gmos$data/chipgaps.dat"
#gfreduce.low_rej=3                         # not in bryans script
#gfreduce.high_rej=3                         # not in bryans script
#gfreduce.niter=5                         # not in bryans script
gfreduce.bias="gN20051204S0227_bias.fits"
gfreduce.reference=""
#gfreduce.qe_refim=""
gfreduce.response=""                        # Don't use this; do our own flat fielding
gfreduce.wavtraname=""
gfreduce.sfunction=""
gfreduce.extinction=""
gfreduce.fl_novlap=yes
gfreduce.perovlap=10.0
#gfreduce.nbiascontam="default"                         # not in bryans script
#gfreduce.biasrows="3:64"                         # not in bryans script
gfreduce.order=1

gfreduce.line=INDEF
gfreduce.nsum=10
gfreduce.trace=yes
gfreduce.recenter=yes
gfreduce.thresh=200.
gfreduce.t_order=21
gfreduce.t_nsum=10
gfreduce.gratingdb="gmos$data/GMOSgratings.dat"
gfreduce.filterdb="gmos$data/GMOSfilters.dat"
gfreduce.xoffset=INDEF
gfreduce.expr="default"
gfreduce.observatory="default"
gfreduce.logfile=""
gfreduce.verbose=yes

# Parameter's that James uses
gfreduce.function="spline3"                 # defulat: chebyshev
gfreduce.order=1                            # defulat: 5
gfreduce.weights="none"                     # defulat: variance
#gfreduce.grow=1.5                           # defulat: 1                         # not in bryans script
#gfreduce.fl_fixgaps=yes                     # defulat: no                         # not in bryans script

gbias.logfile=""
gbias.rawpath="rawdir$"
gbias.fl_over=yes
gbias.fl_trim=yes
gbias.key_biassec="BIASSEC"
gbias.key_datasec="DATASEC"
gbias.bpm=""
gbias.sat="default"
gbias.nbiascontam="default"
gbias.biasrows="default"
gbias.fl_inter=yes
gbias.median=no
gbias.function="chebyshev"
gbias.order=1
gbias.low_reject=2.0                        # overscan
gbias.high_reject=2.0
gbias.order=1
gbias.niter=11
gbias.combine="average"
gbias.reject="avsigclip"
gbias.lthreshold=INDEF
gbias.hthreshold=INDEF
gbias.masktype="goodvalue"
gbias.maskvalue=0.0
gbias.scale="none"
gbias.zero="none"
gbias.weight="none"
gbias.statsec="[*,*]"
gbias.mclip=yes
gbias.lsigma=2.0                            # combine
gbias.hsigma=2.0
gbias.fl_vardq=yes
gbias.verbose=yes

gswavelength.dispaxis=1
#gswavelength.coordlist="IFU_example_data/cuar.dat"
gswavelength.section="middle line"
gswavelength.nsum=1
gswavelength.ftype="emission"
gswavelength.fwidth=10.0
gswavelength.gsigma=0.0
gswavelength.cradius=10.0
gswavelength.nlost=10
gswavelength.minsep=2.5
gswavelength.refit=yes
gswavelength.step=1
gswavelength.trace=yes
gswavelength.low_rej=2.5
gswavelength.high_rej=2.5
gswavelength.fl_addfeat=yes
gswavelength.aiddebug="s"
gswavelength.fl_dbwrite="YES"
gswavelength.fl_overwrite=yes

gfscatsub.outimage=""
gfscatsub.prefix="b"
gfscatsub.xorder="5,9,5"                    # try 5,5,9,5,5,5 for new GMOS-N CCDs
gfscatsub.yorder="5,7,5"                    # try 5,5,9,5,5,5 for new GMOS-N CCDs
gfscatsub.cross=yes

# Mainly defaults for the record, not set by gfreduce
gemcrspec.xorder=9
gemcrspec.yorder=-1
gemcrspec.sigclip=4.5                       # Sometimes needs changing for higher-contrast data
gemcrspec.sigfrac=0.32                      # 1.4 sigma is 84%
gemcrspec.objlim=1.0
gemcrspec.niter=5
gemcrspec.fl_vardq=yes
gemcrspec.logfile="example.log"
gemcrspec.verbose=yes

gfskysub.outimages=""
gfskysub.outpref="s"
gfskysub.expr="default"                     # same as gfreduce default
gfskysub.combine="average"
gfskysub.reject="avsigclip"
gfskysub.scale="none"
gfskysub.zero="none"
gfskysub.weight="none"
gfskysub.lthreshold=INDEF
gfskysub.hthreshold=INDEF
gfskysub.lsigma=3.0
gfskysub.hsigma=3.0
gfskysub.fl_inter=no

#rvidlines.observatory="gemini-north"       # remember to change throughout for GS!
rvidlines.nsum=1
rvidlines.maxfeatures=10
rvidlines.ftype="emission"
rvidlines.fwidth=10.
rvidlines.cradius=10.
rvidlines.threshold=10.
rvidlines.minsep=5.
rvidlines.logfile="rvid.log"

gemfix.grow=1.5
gemfix.bitmask=65535
gemfix.axis=1
gemfix.order=0
gemfix.low_reject=3.0
gemfix.high_reject=2.3
gemfix.niterate=5

gfextract.fl_vardq=yes

## Use bpms for the appropriate binning, mbpm is created from the others
ifuproc_gqecorr.mbpm="gn_bpm2x1m.fits"
ifuproc_gqecorr.bpm1="mygmos$bpms/gn_bpm_ccd1_2x1f.pl"
ifuproc_gqecorr.bpm2="mygmos$bpms/gn_bpm_ccd2_2x1f.pl"
ifuproc_gqecorr.bpm3="mygmos$bpms/gn_bpm_ccd3_2x1f.pl"
ifuproc_gqecorr.weights="none"
ifuproc_gqecorr.bpmgaps="gmos$data/chipgaps.dat"    # Width of chip gap and feature width, this data is 2x1
ifuproc_gqecorr.gap12=19
ifuproc_gqecorr.gap23=19
ifuproc_gqecorr.fwidth=2.


# Notes:
# ------
# ifuproc works best in pyraf:
#   the standard gftransform does not work in pyraf as there's an issue with the variable 'scilistout'
# Make sure to change the task definition above depending on environment


# Preliminary reduction
# ---------------------

## This step includes all the commands necessary to reduce the data, but not all steps are automated.
## The main task not automated is the veolcity shift correction. It is still required to interactively determine
##     the velocity shift based on the two arcs, and to correct the data in the opposite way to the arcs.
## Tasks which have been run previously have been commented out with a single #

    # Prepare the bias, twilights, flux standars, and science images
    # --------------------------------------------------------------

        ## Biases - combine
#            gemlist N20051204S 227-231 > bias.lis
#            gbias @bias.lis gN20051204S0227_bias.fits rawpath=rawdir$ fl_vardq+ fl_inter-
#            gemlist N20051220S 228-232 > bias20.lis
#            gbias @bias20.lis gN20051220S0228_bias.fits rawpath=rawdir$ fl_vardq+ fl_inter-

        ## Twilight - bias subtract
#            gemlist N20051203S 239-241 > twi.lis
#            gfreduce @twi.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20051204S0227_bias.fits

       ## Flux standards - bias subtract
#            gemlist N20051206S 133,134,135,138 > dec06.lis
#            gfreduce @dec06.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20051204S0227_bias.fits

        ## GALAXY science images - bias subtract
#            gemlist N20051205S 5-8 > dec05.lis
#            gfreduce @dec05.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20051204S0228_bias.fits

#            gfreduce N20051205S0006.fits fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20051204S0227_bias.fits

#            gemlist N20051222S 106-114 > dec22.lis
#            gfreduce @dec22.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20051220S0228_bias.fits
                # should be using bias 228 according to gwen

#            gemlist N20051223S 119-122 > dec23.lis
#            gfreduce @dec23.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20051220S0228_bias.fits


    # Process the standards, Hiltner600
    # ---------------------------------

        ## inputs: image, flat(s), arc(s)

#        ifuproc_gqecorr rgN20051206S0133 rgN20051206S0135 rgN20051206S0138 fl_inter- \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr=yes # dw=.91 nw=1301 w1=4186 twilight=rgN20051203S0240

#        ifuproc_gqecorr rgN20051206S0134 rgN20051206S0135 rgN20051206S0138 fl_inter- \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr=yes # dw=.91 nw=1301 w1=4186 twilight=rgN20051203S0239

        #### not sure if necessary, gwen puts through a twilight? from dec03, perhaps as a test of the flat fielding?
        ## I do this in a separte reduction '*_twi.cl'
        ##ifuproc rgN20051203S0240 rgN20051203S0244 rgN20051203S0245 twilight=rgN20051203S0239 fl_inter- \
        ##    bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+

        ## Visually confirm proper reconstructed spectra
#        gfdisplay steqpxbprgN20051206S0134.fits ver=1 z1=0 z2=1.e8

        ## Sum the stellar spectra

#        gfapsum steqpxbprgN20051206S0133.fits fl_inter-
#        gfapsum steqpxbprgN20051206S0134.fits fl_inter-

#        gscombine asteqpxbprgN20051206S0133.fits,asteqpxbprgN20051206S0134.fits hiltner600_wl.fits logfile="gmos.log" \
#            combine="average" scale="mean" sample="4550:4850" fl_vardq-

        ## Establish  spectrophotometric  calibration  for GMOS spectra
            ## correction curve should always be made interactively - avoid regions with strong absorption lines by
            ##       using keystroke commands to delete and add boxes away from the absorption lines
            ##   a: adds new bandpass, aa: make a box, d: deletes boxes closest to cusuror, q: quit

#        gsstandard hiltner600_wl.fits caldir="onedstds$ctionewcal/" observatory="Gemini-North" fl_inter+ starname="h600" \
#            extinction="gmos$calib/mkoextinct.dat" sfunction="sens_jamesiraf_wl" sfile="std_jamesiraf_wl"

#        splot sens_jamesiraf_wl

    # Measure velocity difference between the two output slits using arcs - only done once
    # -------------------------------------------------------------------

        #### Calculate average shift  - as done by gwen, these numbers are not from my use
        ## We have found small pixel offsets between the two pseudo slits that are not removed by the wavelength
        ## calibration. The reason for this is not understood but here is one workaround using the arc to determine the
        ## shift and then applying it to the science data.

        #   gftransform ergN20051205S0008.fits wavtraname=ergN20051205S0008
        #   gfxcor tergN20051205S0008.fits obs=Gemini-North
        #   tselect tergN20051205S0008.fits[mdf] s008_1.fits "NO <= 750"
        #   tselect tergN20051205S0008.fits[mdf] s008_2.fits "NO >= 751"
        #   tstat s008_1.fits,s008_2.fits SHIFT lowlim=-9999.0 highlim=15.
                # nrows            mean        stddev        median           min           max
                # s008_1.fits  SHIFT
                #     749    0.006841121504     0.0197255         0.002        -0.031         0.118
                # s008_2.fits  SHIFT
                #     747      0.1190000001     0.0350511         0.122         0.022         0.188
        #   tstat s008_1.fits,s008_2.fits VREL lowlim=-9999.0 highlim=10.
                # nrows            mean        stddev        median           min           max
                # s008_1.fits  VREL
                #     749      0.3953102799       1.13771        0.1103       -1.7747        6.7907
                # s008_2.fits  VREL
                #     720       6.737034717       1.94682        6.9522        1.2856        9.9512
        ## 0.119-0.0068 = 0.1122

        #   gftransform ergN20051205S0005.fits wavtraname=ergN20051205S0005
        #   gfxcor tergN20051205S0005.fits obs=Gemini-North
        #   tselect tergN20051205S0005.fits[mdf] s005_1.fits "NO <= 750"
        #   tselect tergN20051205S0005.fits[mdf] s005_2.fits "NO >= 751"
        #   tstat s005_1.fits,s005_2.fits SHIFT lowlim=-9999.0 highlim=15.
                # s005_1.fits  SHIFT
                #     749    0.007567423196     0.0197136         0.002        -0.031         0.095
                # s005_2.fits  SHIFT
                #     747      0.1146465865     0.0342911         0.117          0.01         0.184
        #   tstat s005_1.fits,s005_2.fits VREL lowlim=-9999.0 highlim=10.
                # s005_1.fits  VREL
                #     749      0.4362243005       1.13696        0.1431       -1.8059        5.4879
                # s005_2.fits  VREL
                #     735        6.55279117       1.93724        6.7405        0.5567        9.9589
        # 0.11464 - 0.007567 = 0.107079
        # (0.1122 + 0.107079)/2 = 0.10963

        #### calculate the shift - subtract the difference with gfshit and confirm the new shift ~0
        #   gfshift tergN20051205S0008.fits stergN20051205S0008.fits shift2=-0.115
        #   gfxcor stergN20051205S0008.fits obs=Gemini-North
        #   delete slit?.fits
        #   tselect stergN20051205S0008.fits[mdf] slit1.fits "NO <= 750"
        #   tselect stergN20051205S0008.fits[mdf] slit2.fits "NO >= 751"
        #   tstat slit1.fits,slit2.fits SHIFT lowlim=-1000.0 highlim=1000.

        ## slit1.fits  SHIFT
        ##  749     0.01689319103      0.019838         0.012        -0.023         0.112
        ## slit2.fits  SHIFT
        ##  747     0.02548995992     0.0365223         0.028        -0.073         0.098


    # Process the science
    # -------------------

        ## Dec 05 - N20051205S0006, shift=-0.115

            ## Ifuproc - central wavelength is 478 so flat is 240

#            ifuproc_gqecorr rgN20051205S0006 rgN20051205S0007 rgN20051205S0008,rgN20051205S0005 \
#                 bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub- fl_inter+ fl_sepslits+ fl_fixgaps+
            # dw=.91 nw=1301 w1=4186 twilight=rgN20051203S0240

            ## visually inspect reconstructed image
#            gfdisplay steqpxbprgN20051205S0006.fits ver=1 z1=0 z2=1.e8

                # s008_1.fits  SHIFT
                #     749    0.006841121504     0.0197255         0.002        -0.031         0.118
                # s008_2.fits  SHIFT
                #     747      0.1190000001     0.0350511         0.122         0.022         0.188
                # s005_1.fits  SHIFT
                #     749    0.007567423196     0.0197136         0.002        -0.031         0.095
                # s005_2.fits  SHIFT
                #     747      0.1146465865     0.0342911         0.117          0.01         0.184
            # ((0.11900 - 0.006841) + (0.11464 - 0.007567))/2 = 0.109616

#            gfshift steqpxbprgN20051205S0006.fits hsteqpxbprgN20051205S0006.fits shift2=-0.109616

            ## Calibrate and visually inspect
#            gscalibrate hsteqpxbprgN20051205S0006.fits extinction=gmos$calib/mkoextinct.dat fl_ext+ fl_vardq+ \
#                sfunction="sens_jamesiraf_wl"

#            gfdisplay chsteqpxbprgN20051205S0006.fits ver=1 z2=500 z1=0


        ## Dec 22 - N20051222S shift=-0.1042, N20051222S0112 shift=-0.1082

            ifuproc_gqecorr rgN20051222S0108 rgN20051222S0107 rgN20051222S0109,rgN20051222S0106 \
                bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub- fl_inter- fl_sepslits+ fl_fixgaps+
            # dw=.91 nw=1301 w1=4186 twilight=rgN20051203S0241
#            gfdisplay steqpxbprgN20051222S0108.fits ver=1 z2=1.e8

                # s109_1.fits  SHIFT
                #   749    0.001647530023     0.0175282        -0.002         -0.04         0.078
                # s109_2.fits  SHIFT
                #   748     0.08808021412     0.0338843         0.091        -0.048         0.173
                # s106_1.fits  SHIFT
                #   749    0.009959946613     0.0214974         0.007        -0.349         0.085
                # s106_2.fits  SHIFT
                #   748     0.09703074879      0.033803         0.098        -0.014         0.169
            # ((0.08808 - 0.0016475) + (0.09703 - 0.0099599))/2 = 0.08675

            gfshift steqpxbprgN20051222S0108.fits hsteqpxbprgN20051222S0108.fits shift2=-0.08675
            gscalibrate hsteqpxbprgN20051222S0108.fits extinction=gmos$calib/mkoextinct.dat fl_ext+ fl_vardq+ \
                sfunction="sens_jamesiraf_wl"
#            gfdisplay chsteqpxbprgN20051222S0108.fits ver=1 z2=500

            ifuproc_gqecorr rgN20051222S0112 rgN20051222S0113 rgN20051222S0111,rgN20051222S0114 \
                bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub- fl_inter- fl_sepslits+ fl_fixgaps+
            # dw=.91 nw=1301 w1=4186 twilight=rgN20051203S0240
#            gfdisplay steqpxbprgN20051222S0112.fits ver=1 z2=1.e8

                # s111_1.fits  SHIFT
                #  749    0.004319092122      0.017283            0.        -0.029         0.071
                # s111_2.fits  SHIFT
                #  748       -0.20286364        8.5069          0.11       -232.55         0.194
                # s114_1.fits  SHIFT
                #  749    0.002574098771     0.0173254        -0.001         -0.04         0.079
                # s114_2.fits  SHIFT
                #  748      0.1098328879     0.0353038         0.113        -0.009         0.182
             # ((-0.202863 - 0.00431909) + (0.109832 - 0.002574))/2 = -0.04996

            gfshift steqpxbprgN20051222S0112.fits hsteqpxbprgN20051222S0112.fits shift2=0.04996
            gscalibrate hsteqpxbprgN20051222S0112.fits extinction=gmos$calib/mkoextinct.dat fl_ext+ fl_vardq+ \
                sfunction="sens_jamesiraf_wl"
#            gfdisplay chsteqpxbprgN20051222S0112.fits ver=1 z2=500

        ## Dec 23 - N20051223S0121 shift=-0.1047

            ifuproc_gqecorr rgN20051223S0121 rgN20051223S0120 rgN20051223S0122 fl_inter- \
                bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub- fl_sepslits+ fl_fixgaps+
            # dw=.91 nw=1301 w1=4186 twilight=rgN20051203S0241
#            gfdisplay steqpxbprgN20051223S0121.fits ver=1 z2=1.e8 weights="none"

                # s122_1.fits  SHIFT
                #  749    0.005212283049     0.0181066         0.001        -0.035         0.088
                # s122_2.fits  SHIFT
                #  748     0.09383422486     0.0340952         0.096         -0.01         0.161
             # 0.09383422486 - 0.005212283049 = 0.088621

            gfshift steqpxbprgN20051223S0121.fits hsteqpxbprgN20051223S0121.fits shift2=-0.088621
            gscalibrate hsteqpxbprgN20051223S0121.fits extinction=gmos$calib/mkoextinct.dat fl_ext+ fl_vardq+ \
                sfunction="sens_jamesiraf_wl"
#            gfdisplay chsteqpxbprgN20051223S0121.fits ver=1 z2=500


## Reorganise the data into 3D cubes - James' method
## ---------------------------------

# I SKIP THIS - Included because this is what James does
        #### SHOULD be using rvidlines to correct for any drifts in the wavelength zero point, since we're using
        #### a day-time arc. NOT yet sure how this works.
            ## rvidlines.coordlist="skylines.dat"
            ## rvidlines steqpxbprgN20051205S0006.fits[sky] threshold=7.
            ## rvidlines steqpxbprgN20051222S0108.fits[sky] threshold=7.
            ## rvidlines steqpxbprgN20051222S0112.fits[sky] threshold=7.
            ## rvidlines steqpxbprgN20051223S0121.fits[sky] threshold=7.
        #### Then, adjust the data prior to sky subtraction along with the final data to check how well the lines are registered
        #### CHANGE VALUES
            ## hedit teqpxbprgN20051205S0006.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit csteqpxbprgN20051205S0006.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit teqpxbprgN20051222S0108.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit csteqpxbprgN20051222S0108.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit teqpxbprgN20051222S0112.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit csteqpxbprgN20051222S0112.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit teqpxbprgN20051223S0121.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit csteqpxbprgN20051223S0121.fits[sci] CRVAL1 5618.164 upd+ ver-
        #### Then, sum over the WCS-corrected spectra & overplot (manually) for comparison
            ## improj teqpxbprgN20051205S0006[sci] t0006_sum projax=2 average-
            ## improj teqpxbprgN20051222S0108[sci] t0108_sum projax=2 average-
            ## improj teqpxbprgN20051222S0112[sci] t0112_sum projax=2 average-
            ## improj teqpxbprgN20051223S0121[sci] t0121_sum projax=2 average-

# DO THIS

    ## Resample to 3D with (minimal) atmospheric dispersion correction:
    gfcube ("chsteqpxbprgN20051205S0006.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
    gfcube ("chsteqpxbprgN20051222S0108.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
    gfcube ("chsteqpxbprgN20051222S0112.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
    gfcube ("chsteqpxbprgN20051223S0121.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)

    ## Visually inspect for noise, determine range to crop the cube to
#    display dchsteqpxbprgN20051205S0006.fits
#    display dchsteqpxbprgN20051222S0108.fits
#    display dchsteqpxbprgN20051222S0112.fits
#    display dchsteqpxbprgN20051223S0121.fits
    scrop ("dchsteqpxbprgN20051205S0006.fits", "dchsteqpxbprgN20051205S0006_scropd.fits", section="4173:5404", fl_vardq+)
    scrop ("dchsteqpxbprgN20051222S0108.fits", "dchsteqpxbprgN20051222S0108_scropd.fits", section="4173:5404", fl_vardq+)
    scrop ("dchsteqpxbprgN20051222S0112.fits", "dchsteqpxbprgN20051222S0112_scropd.fits", section="4173:5404", fl_vardq+)
    scrop ("dchsteqpxbprgN20051223S0121.fits", "dchsteqpxbprgN20051223S0121_scropd.fits", section="4173:5404", fl_vardq+)

    ## # Mosaic the datacubes:
    pyfalign dchsteqpxbprgN20051205S0006_scropd,dchsteqpxbprgN20051222S0108_scropd,dchsteqpxbprgN20051222S0112_scropd,dchsteqpxbprgN20051223S0121_scropd \
       method="correlate"
    pyfmosaic dchsteqpxbprgN20051205S0006_scropd,dchsteqpxbprgN20051222S0108_scropd,dchsteqpxbprgN20051222S0112_scropd,dchsteqpxbprgN20051223S0121_scropd \
        dchsteqpxbprgN20051205S0006_scropd_add separate- var+

# I STOP HERE - agian this is something James does that I don't

            ## Also make some cubes with sky lines included, to check for deterioration in FWHM after mosaicking:
        #    gfcube ("teqpxbprgN20051205S0006.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
        #    gfcube ("teqpxbprgN20051222S0108.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
        #    gfcube ("teqpxbprgN20051222S0112.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
        #    gfcube ("teqpxbprgN20051223S0121.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)


        ## CHANGE VALUES
            ## Give them the same offsets from pyfalign as the science cubes (after looking at the results from above):
        #    hedit dchsteqpxbprgN20051205S0006[sci] CRVAL1 64.99041999992549 upd+ ver-
        #    hedit dchsteqpxbprgN20051205S0006[sci] CRVAL2 0.04500000992549393 upd+ ver-
        #    hedit dchsteqpxbprgN20051222S0108[sci] CRVAL1 64.99041999992549 upd+ ver-
        #    hedit dchsteqpxbprgN20051222S0108[sci] CRVAL2 0.04500000992549393 upd+ ver-
        #    hedit dchsteqpxbprgN20051222S0112[sci] CRVAL1 65.48042000722705 upd+ ver-
        #    hedit dchsteqpxbprgN20051222S0112[sci] CRVAL2 0.04500000992549393 upd+ ver-
        #    hedit dchsteqpxbprgN20051223S0121[sci] CRVAL1 65.47042000707805 upd+ ver-
        #    hedit dchsteqpxbprgN20051223S0121[sci] CRVAL2 0.04500000992549393 upd+ ver-

            ## Mosaic the object + sky cubes: A quick imexam comparison with the first cube shows minimal if any
            ## degradation, with FWHM differences within 0.1-0.3 pix in both directions that look consistent with noise.
        #    pyfmosaic dcsteqpxbprgN20051205S0006,dcsteqpxbprgN20051222S0108,dcsteqpxbprgN20051222S0112,dcsteqpxbprgN20051223S0121 \
        #        dcsteqpxbprgN20051205S0006_add separate-


#### Gwen's method for making cubes
# ---------------------------------

    ## This is achieved with the task call 'call_cube.cl' which takes input (original file name, file extension number)

    ## Make sure to comment out 'gfcube' task in this script is already gfcube'd
#    make_cube.prefix="steqpxbprg"
#    make_cube ("N20051205S0006.fits", 006)
#    make_cube ("N20051222S0108.fits", 108)
#    make_cube ("N20051222S0112.fits", 112)
#    make_cube ("N20051223S0121.fits", 122)

## The output of this program is the fully shifted and combines cube - with both integer and decimal shifts.
## You may want to consider at this point cropping the final cubes in the spatial plane to remove the blank
##    sections added in the shift.

#    mkdir tmp_cal       # Make temporary folders to organise output - only if it does not exist already

#    align_cubes.prefix="steqpxbprg"         ## 'mdc' prefix will be added in where appropriate
#    align_cubes ("N20051205S0006", "006")
#    align_cubes ("N20051222S0108", "108")
#    align_cubes ("N20051222S0112", "112")
#    align_cubes ("N20051223S0121", "122")

    ## Combine the data cubes
#    dele calib_cubes_decimal.lis
#    print("amdcsteqpxbprgN20051205S0006_decimal.fits",>> "calib_cubes_decimal.lis")
#    print("amdcsteqpxbprgN20051222S0108_decimal.fits",>> "calib_cubes_decimal.lis")
#    print("amdcsteqpxbprgN20051222S0112_decimal.fits",>> "calib_cubes_decimal.lis")
#    print("amdcsteqpxbprgN20051223S0121_decimal.fits",>> "calib_cubes_decimal.lis")

#    dele calib_cubes_integer.lis
#    print("amdcsteqpxbprgN20051205S0006_integer.fits",>> "calib_cubes_integer.lis")
#    print("amdcsteqpxbprgN20051222S0108_integer.fits",>> "calib_cubes_integer.lis")
#    print("amdcsteqpxbprgN20051222S0112_integer.fits",>> "calib_cubes_integer.lis")
#    print("amdcsteqpxbprgN20051223S0121_integer.fits",>> "calib_cubes_integer.lis")

    ## First the decimal shifts
#    gscombine_new @calib_cubes_decimal.lis IC225_cal_decimal.fits logfile="gmos.log" combine="average" lthresh=-9999 fl_vard+
    ## The integer shifts
#    gscombine_new @calib_cubes_integer.lis IC225_cal_integer.fits logfile="gmos.log" combine="average" lthresh=-9999 fl_vard+

## To make 2D 'maps' fo the galaxy - use scrop to obtain a cube within the desired wavelength range, and then use
##    imcombine with 'project=yes' to flatten the cube inta a 2D image.

