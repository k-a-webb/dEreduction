# Written by Kristi Webb Aug 2015 for Gemini GMOS IFU program GN-2008A-Q-35

## 2008-03-22
# N20080322S0049  GN-2008A-Q-35-27  22:43:43.1  0.99931883812     HD102328
# N20080322S0050  GN-2008A-Q-35-28  22:48:09.1  179.998117924     CuAr
# N20080322S0051  GN-2008A-Q-35-28  22:53:30.1  79.9988541603     GCALflat
# N20080322S0052  GN-2008A-Q-35-28  22:57:22.1  119.998653889     HD102328
# N20080322S0054  GN-2008A-Q-35-27  23:22:44.1  0.999619960785    HD102328
# N20080322S0660  GN-CAL20080322-1  07:56:52.1  0.00050687789917  Bias
# N20080322S0661  GN-CAL20080322-1  07:59:07.1  0.000533819198608 Bias
# N20080322S0663  GN-CAL20080322-1  08:03:36.1  0.000507116317749 Bias
# N20080322S0664  GN-CAL20080322-1  08:05:51.1  15.5886979103     Bias

## 2008-06-02
# N20080602S0018  GN-2008A-Q-35-14  21:40:46.4  9.99924898148     HECJ125931.9+275140
# N20080602S0019  GN-2008A-Q-35-14  21:43:35.4  59.999145031      HECJ125931.9+275140
# N20080602S0020  GN-2008A-Q-35-14  22:07:22.4  59.9988231659     HECJ125931.9+275140
# N20080602S0021  GN-2008A-Q-35-13  22:11:56.4  2604.97747803     HECJ125931.9+275140
# N20080602S0022  GN-2008A-Q-35-13  22:57:42.4  2604.97733712     HECJ125931.9+275140
# N20080602S0023  GN-2008A-Q-35-13  23:43:38.4  179.998532057     CuAr
# N20080602S0024  GN-2008A-Q-35-13  23:48:59.4  79.9990489483     GCALflat
# N20080602S0041  GN-2008A-Q-35-25  01:34:38.4  0.999320030212    HD140283
# N20080602S0042  GN-2008A-Q-35-25  01:36:43.4  0.999633073807    HD140283
# N20080602S0043  GN-2008A-Q-35-26  01:39:57.4  119.998664856     HD140283
# N20080602S0044  GN-2008A-Q-35-26  01:44:27.4  79.9990029335     GCALflat
# N20080602S0045  GN-2008A-Q-35-26  01:48:08.4  179.998157978     CuAr
# N20080602S0061  GN-2008A-Q-35-9   04:32:21.4  4.99959516525     EG131
# N20080602S0062  GN-2008A-Q-35-9   04:34:41.4  9.99940800667     EG131
# N20080602S0063  GN-2008A-Q-35-10  04:38:46.4  179.998449087     CuAr
# N20080602S0064  GN-2008A-Q-35-10  04:44:07.4  79.9989459515     GCALflat
# N20080602S0065  GN-2008A-Q-35-10  04:47:58.4  179.998100042     EG131
# N20080602S0077  GN-2008A-Q-35-8   05:19:48.4  119.998550892     Twilight
# N20080602S0078  GN-2008A-Q-35-8   05:25:33.4  19.9991369247     Twilight
# N20080602S0079  GN-2008A-Q-35-8   05:29:34.4  59.9991738796     Twilight
# N20080602S0080  GN-2008A-Q-35-8   05:34:52.4  119.998646021     Twilight
# N20080602S0148  GN-CAL20080602-3  06:22:43.4  0.00051212310791  Bias
# N20080602S0149  GN-CAL20080602-3  06:24:58.4  0.000524997711182 Bias
# N20080602S0150  GN-CAL20080602-3  06:27:13.4  0.000524997711182 Bias
# N20080602S0151  GN-CAL20080602-3  06:29:27.4  15.5887138844     Bias
# N20080602S0152  GN-CAL20080602-3  06:31:43.4  0.000519037246704 Bias

## 2008-06-03
# N20080603S0117  GN-2008A-Q-35-33  21:46:02.4  19.9994850159     HECJ125931.9+275140
# N20080603S0118  GN-2008A-Q-35-33  21:49:12.4  59.9989929199     HECJ125931.9+275140
# N20080603S0119  GN-2008A-Q-35-33  21:52:01.4  59.9991810322     HECJ125931.9+275140
# N20080603S0120  GN-2008A-Q-35-13  21:55:29.4  79.9991121292     GCALflat
# N20080603S0121  GN-2008A-Q-35-13  21:59:10.4  179.998332977     CuAr
# N20080603S0122  GN-2008A-Q-35-13  22:04:42.4  2604.98021698     HECJ125931.9+275140
# N20080603S0123  GN-2008A-Q-35-13  22:50:28.4  2604.97828197     HECJ125931.9+275140
# N20080603S0124  GN-2008A-Q-35-25  23:42:42.4  0.999313831329    HD140283
# N20080603S0125  GN-2008A-Q-35-25  23:44:28.4  0.999634981155    HD140283
# N20080603S0126  GN-2008A-Q-35-26  23:47:53.4  179.998287916     CuAr
# N20080603S0127  GN-2008A-Q-35-26  23:53:14.4  79.9993751049     GCALflat
# N20080603S0128  GN-2008A-Q-35-26  23:57:05.4  119.998781919     HD140283

# 2008-06-07
# N20080607S0241  GN-2008A-Q-35-7   21:29:38.4  9.99923801422     HECJ130035.4+275633
# N20080607S0242  GN-2008A-Q-35-7   21:32:45.4  59.9990439415     HECJ130035.4+275633
# N20080607S0243  GN-2008A-Q-35-7   21:36:18.4  119.998232841     HECJ130035.4+275633
# N20080607S0244  GN-2008A-Q-35-1   21:41:24.4  2604.97600293     HECJ130035.4+275633
# N20080607S0245  GN-2008A-Q-35-1   22:27:11.4  2604.97624612     HECJ130035.4+275633
# N20080607S0246  GN-2008A-Q-35-1   23:13:07.4  179.998077154     CuAr
# N20080607S0247  GN-2008A-Q-35-1   23:18:28.4  79.9988939762     GCALflat
# N20080607S0248  GN-2008A-Q-35-1   23:22:28.4  2604.97583222     HECJ130035.4+275633
# N20080607S0249  GN-2008A-Q-35-1   00:08:24.4  79.9989080429     GCALflat
# N20080607S0250  GN-2008A-Q-35-1   00:12:05.4  179.998396158     CuAr
# N20080607S0480  GN-2008A-Q-85-117 04:43:25.4  3.451             MT507
# N20080607S0481  GN-2008A-Q-35-36  04:49:03.4  0.999321937561    HD201891
# N20080607S0482  GN-2008A-Q-35-36  04:51:30.4  0.999627113342    HD201891
# N20080607S0483  GN-2008A-Q-35-36  04:54:09.4  0.999490022659    HD201891
# N20080607S0484  GN-2008A-Q-35-36  04:56:02.4  0.999494075775    HD201891
# N20080607S0485  GN-2008A-Q-35-37  04:58:41.4  119.998605013     HD201891
# N20080607S0486  GN-2008A-Q-35-37  05:03:12.4  79.9989500046     GCALflat
# N20080607S0487  GN-2008A-Q-35-37  05:06:53.4  179.998332024     CuAr
# N20080607S0488  GN-2008A-Q-35-37  05:12:32.4  119.998594046     HD201891
# N20080607S0489  GN-2008A-Q-35-37  05:17:03.4  179.998008966     CuAr
# N20080607S0490  GN-2008A-Q-35-37  05:22:24.4  79.9989571571     GCALflat
# N20080607S0494  GN-2008A-Q-35-8   05:36:05.4  119.998837948     Twilight
# N20080607S0517  GN-CAL20080607-7  05:49:23.4  15.5887041092     Bias
# N20080607S0518  GN-CAL20080607-7  05:51:38.4  0.000499963760376 Bias
# N20080607S0519  GN-CAL20080607-7  05:53:53.4  0.00049090385437  Bias
# N20080607S0520  GN-CAL20080607-7  05:56:08.4  0.000524997711182 Bias
# N20080607S0521  GN-CAL20080607-7  05:58:23.4  15.5887041092     Bias

## 2008-06-21
# N20080621S0355  GN-CAL20080621-7  05:38:25.6  15.5886881351     Bias
# N20080621S0356  GN-CAL20080621-7  05:40:41.6  0.000502824783325 Bias
# N20080621S0357  GN-CAL20080621-7  05:42:56.6  15.5887138844     Bias
# N20080621S0358  GN-CAL20080621-7  05:45:11.6  15.5887210369     Bias
# N20080621S0359  GN-CAL20080621-7  05:47:27.6  0.000514984130859 Bias

## 2008-06-22
# N20080622S0044  GN-2008A-Q-35-7   20:40:50.0  59.9988660812     HECJ130035.4+275633
# N20080622S0045  GN-2008A-Q-35-7   20:46:29.0  119.998421907     HECJ130035.4+275633
# N20080622S0046  GN-2008A-Q-35-7   21:18:37.0  119.999143124     HECJ130035.4+275633
# N20080622S0047  GN-2008A-Q-35-1   21:23:54.0  2214.37756014     HECJ130035.4+275633
# N20080622S0049  GN-2008A-Q-35-1   22:09:17.0  79.9990739822     GCALflat
# N20080622S0050  GN-2008A-Q-35-1   22:12:58.0  179.998253822     CuAr

## 2008-07-01
# N20080701S0088  GN-2008A-Q-35-7   20:08:22.7  119.998411179     HECJ130035.4+275633
# N20080701S0089  GN-2008A-Q-35-7   20:12:47.7  119.998231888     HECJ130035.4+275633
# N20080701S0090  GN-2008A-Q-35-1   20:16:55.7  79.9989881516     GCALflat
# N20080701S0091  GN-2008A-Q-35-1   20:20:37.7  179.998068094     CuAr
# N20080701S0092  GN-2008A-Q-35-1   20:26:08.7  2604.97592711     HECJ130035.4+275633

## 2008-07-02
# N20080702S0041  GN-2008A-Q-35-34  19:37:40.7  0.99963593483     HD140283
# N20080702S0042  GN-2008A-Q-35-34  19:39:51.7  0.999627113342    HD140283
# N20080702S0043  GN-2008A-Q-35-34  19:41:33.7  0.999490976334    HD140283
# N20080702S0044  GN-2008A-Q-35-35  19:43:51.7  119.998806        HD140283
# N20080702S0045  GN-2008A-Q-35-35  19:48:22.7  79.9994249344     GCALflat
# N20080702S0046  GN-2008A-Q-35-35  19:52:03.7  179.998364925     CuAr
# N20080702S0047  GN-2008A-Q-35-35  19:57:38.7  179.998686075     CuAr
# N20080702S0048  GN-2008A-Q-35-35  20:02:59.7  79.9991090298     GCALflat
# N20080702S0049  GN-2008A-Q-35-35  20:06:51.7  119.999145985     HD140283

## 2008-07-03
# N20080703S0233  GN-CAL20080703-7  05:55:42.7  15.5887420177     Bias
# N20080703S0234  GN-CAL20080703-7  05:57:57.7  0.000494956970215 Bias
# N20080703S0235  GN-CAL20080703-7  06:00:12.7  0.000516891479492 Bias
# N20080703S0236  GN-CAL20080703-7  06:02:27.7  0.000504016876221 Bias
# N20080703S0237  GN-CAL20080703-7  06:04:41.7  0.000521898269653 Bias


## Aliases
## -------
set dd5=/Users/kwebb/IFU_reduction_q35/proc
set caldir=dd5$calib/
set rawdir=/net/sbfmaps/Volumes/Science/bmiller/bdisk/bmiller/coma_acs/GN-2008A-Q-35/raw/

set mygmos=/Users/kwebb/iraf/scripts/gmos/
set mypyfu=/Users/kwebb/iraf/extern/pyfu-0.8.1/
set jgmos=/Users/kwebb/iraf/extern/ifudrgmos/gmos/
directory.nc=1
set stdimage=imtgmos

## Scripts
## -------
rv
onedspec
gemini
nmisc
gmos
#pyfu

## James' scripts
task gbias=jgmos$gbias.cl
task gbpm=jgmos$gbpm.cl
task gdisplay=jgmos$gdisplay.cl
task gfapsum=jgmos$gfapsum.cl
task gstransform=jgmos$gstransform.cl
task gbias=jgmos$gbias.cl
task gswavelength=jgmos$gswavelength.cl
task gfextract=jgmos$gfextract.cl
task gfapsum=jgmos$gfapsum.cl
#task gireduce=jgmos$gireduce.cl            # Do not use James' version, unresolved error
task gffindblocks=jgmos$gffindblocks.cl
task gfreduce=jgmos$gfreduce.cl
#task gfresponse=jgmos$gfresponse.cl        # can't figure out how to use, needs wavtraname
task gfscatsub=jgmos$gfscatsub.cl
task gfskysub=jgmos$gfskysub.cl
task gftransform=jgmos$gftransform.cl       # Run in IRAF, not pyraf, weird error with scilistout variable
task gfuntransform=jgmos$gfuntransform.par
#task gmosaic=jgmos$gmosaic.cl              # issue with imexpr, use IRAF version
task gprepare=jgmos$gprepare.cl
task gqecorr=jgmos$gqecorr.cl
task gsappwave=jgmos$gsappwave.cl
task gscalibrate=jgmos$gscalibrate.cl
task gscrrej=jgmos$gscrrej.cl
task gsscatsub=jgmos$gsscatsub.cl
task gsstandard=jgmos$gsstandard.cl

task mkmbpm=mygmos$mkmbpm.cl                # no standard
task gfshift=mygmos$gfshift.cl              # no standard
task gkeywpars=mygmos$gkeywpars.cl
task gfxcor=mygmos$gfxcor.cl

# in pyraf
#reset pyfu = "/where/you/put/it/pyfu-0.8.1/"  # remember the trailing slash!
task pyfu.pkg = pyfu$pyfu.cl

task gscombine=/Users/kwebb/iraf/scripts/gwen/gscombine.cl
task gscombine_new=/Users/kwebb/iraf/scripts/gwen/gscombine_new.cl
task align_cubes=mygmos$align_cubes.cl
task make_cube=mygmos$make_cube.cl
task ifuproc_gqecorr=mygmos$ifuproc_gqecorr.cl
#task scrop=mygmos$scrop.cl
task scrop=/Users/kwebb/iraf/scripts/gwen/scrop.cl
task proc_sci=mygmos$proc_sci.cl

# Set one-off parameters reproducibly:
gfreduce.slits="both"
#gfreduce.exslits="*"
gfreduce.fl_nodshuffl=no
gfreduce.fl_inter=no
gfreduce.fl_vardq=yes
gfreduce.fl_addmdf=no
gfreduce.fl_over=no
gfreduce.fl_trim=no
gfreduce.fl_bias=no
#gfreduce.fl_qecorr=no                      # not yet implemented
gfreduce.fl_gscrrej=no
gfreduce.fl_gnsskysub=no
gfreduce.fl_extract=yes
gfreduce.fl_gsappwave=yes
gfreduce.fl_wavtran=yes
gfreduce.fl_skysub=no
gfreduce.fl_fluxcal=no
gfreduce.rawpath="rawdir$"
gfreduce.key_mdf=""
gfreduce.mdffile="default"
gfreduce.mdfdir="gmos$data/"
gfreduce.key_biassec="BIASSEC"
gfreduce.key_datasec="DATASEC"
gfreduce.bpmfile="gmos$data/chipgaps.dat"
#gfreduce.low_rej=3                         # not in bryans script
#gfreduce.high_rej=3                         # not in bryans script
#gfreduce.niter=5                         # not in bryans script
gfreduce.bias="gN20051204S0227_bias.fits"
gfreduce.reference=""
#gfreduce.qe_refim=""
gfreduce.response=""                        # Don't use this; do our own flat fielding
gfreduce.wavtraname=""
gfreduce.sfunction=""
gfreduce.extinction=""
gfreduce.fl_novlap=yes
gfreduce.perovlap=10.0
#gfreduce.nbiascontam="default"                         # not in bryans script
#gfreduce.biasrows="3:64"                         # not in bryans script
gfreduce.order=1

gfreduce.line=INDEF
gfreduce.nsum=10
gfreduce.trace=yes
gfreduce.recenter=yes
gfreduce.thresh=200.
gfreduce.t_order=21
gfreduce.t_nsum=10
gfreduce.gratingdb="gmos$data/GMOSgratings.dat"
gfreduce.filterdb="gmos$data/GMOSfilters.dat"
gfreduce.xoffset=INDEF
gfreduce.expr="default"
gfreduce.observatory="default"
gfreduce.logfile=""
gfreduce.verbose=yes

# Parameter's that James uses
gfreduce.function="spline3"                 # defulat: chebyshev
gfreduce.order=1                            # defulat: 5
gfreduce.weights="none"                     # defulat: variance
#gfreduce.grow=1.5                           # defulat: 1                         # not in bryans script
#gfreduce.fl_fixgaps=yes                     # defulat: no                         # not in bryans script

gbias.logfile=""
gbias.rawpath="rawdir$"
gbias.fl_over=yes
gbias.fl_trim=yes
gbias.key_biassec="BIASSEC"
gbias.key_datasec="DATASEC"
gbias.bpm=""
gbias.sat="default"
gbias.nbiascontam="default"
gbias.biasrows="default"
gbias.fl_inter=yes
gbias.median=no
gbias.function="chebyshev"
gbias.order=1
gbias.low_reject=2.0                        # overscan
gbias.high_reject=2.0
gbias.order=1
gbias.niter=11
gbias.combine="average"
gbias.reject="avsigclip"
gbias.lthreshold=INDEF
gbias.hthreshold=INDEF
gbias.masktype="goodvalue"
gbias.maskvalue=0.0
gbias.scale="none"
gbias.zero="none"
gbias.weight="none"
gbias.statsec="[*,*]"
gbias.mclip=yes
gbias.lsigma=2.0                            # combine
gbias.hsigma=2.0
gbias.fl_vardq=yes
gbias.verbose=yes

gswavelength.dispaxis=1
#gswavelength.coordlist="IFU_example_data/cuar.dat"
gswavelength.section="middle line"
gswavelength.nsum=1
gswavelength.ftype="emission"
gswavelength.fwidth=10.0
gswavelength.gsigma=0.0
gswavelength.cradius=10.0
gswavelength.nlost=10
gswavelength.minsep=2.5
gswavelength.refit=yes
gswavelength.step=1
gswavelength.trace=yes
gswavelength.low_rej=2.5
gswavelength.high_rej=2.5
gswavelength.fl_addfeat=yes
gswavelength.aiddebug="s"
gswavelength.fl_dbwrite="YES"
gswavelength.fl_overwrite=yes

gfscatsub.outimage=""
gfscatsub.prefix="b"
gfscatsub.xorder="5,9,5"                    # try 5,5,9,5,5,5 for new GMOS-N CCDs
gfscatsub.yorder="5,7,5"                    # try 5,5,9,5,5,5 for new GMOS-N CCDs
gfscatsub.cross=yes

# Mainly defaults for the record, not set by gfreduce
#gemcrspec.xorder=9
#gemcrspec.yorder=-1
#gemcrspec.sigclip=4.5                       # Sometimes needs changing for higher-contrast data
#gemcrspec.sigfrac=0.32                      # 1.4 sigma is 84%
#gemcrspec.objlim=1.0
#gemcrspec.niter=5
#gemcrspec.fl_vardq=yes
#gemcrspec.logfile="example.log"
#gemcrspec.verbose=yes

gfskysub.outimages=""
gfskysub.outpref="s"
gfskysub.expr="default"                     # same as gfreduce default
gfskysub.combine="average"
gfskysub.reject="avsigclip"
gfskysub.scale="none"
gfskysub.zero="none"
gfskysub.weight="none"
gfskysub.lthreshold=INDEF
gfskysub.hthreshold=INDEF
gfskysub.lsigma=3.0
gfskysub.hsigma=3.0
gfskysub.fl_inter=no

#rvidlines.observatory="gemini-north"       # remember to change throughout for GS!
rvidlines.nsum=1
rvidlines.maxfeatures=10
rvidlines.ftype="emission"
rvidlines.fwidth=10.
rvidlines.cradius=10.
rvidlines.threshold=10.
rvidlines.minsep=5.
rvidlines.logfile="rvid.log"

#gemfix.grow=1.5
#gemfix.bitmask=65535
#gemfix.axis=1
#gemfix.order=0
#gemfix.low_reject=3.0
#gemfix.high_reject=2.3
#gemfix.niterate=5

gfextract.fl_vardq=yes

## Use bpms for the appropriate binning, mbpm is created from the others
ifuproc_gqecorr.mbpm="gn_bpm2x1m.fits"
ifuproc_gqecorr.bpm1="mygmos$bpms/gn_bpm_ccd1_1x1f.pl"
ifuproc_gqecorr.bpm2="mygmos$bpms/gn_bpm_ccd2_1x1f.pl"
ifuproc_gqecorr.bpm3="mygmos$bpms/gn_bpm_ccd3_1x1f.pl"
ifuproc_gqecorr.weights="none"
ifuproc_gqecorr.bpmgaps="gmos$data/chipgaps.dat"    # Width of chip gap and feature width, this data is 2x1
ifuproc_gqecorr.gap12=19
ifuproc_gqecorr.gap23=19
ifuproc_gqecorr.fwidth=2.


# Notes:
# ------
# ifuproc works best in pyraf:
#   the standard gftransform does not work in pyraf as there's an issue with the variable 'scilistout'
# Make sure to change the task definition above depending on environment


# Preliminary reduction
# ---------------------

## This step includes all the commands necessary to reduce the data, but not all steps are automated.
## The main task not automated is the veolcity shift correction. It is still required to interactively determine
##     the velocity shift based on the two arcs, and to correct the data in the opposite way to the arcs.
## Tasks which have been run previously have been commented out with a single #

    # Prepare the bias, twilights, flux standars, and science images
    # --------------------------------------------------------------

        ## Biases - make list for each observation date, combine
#            gemlist N20080322S 660,661,663,664 > bias0322.lis
#            gbias @bias0322.lis gN20080322S0660_bias.fits rawpath=rawdir$ fl_vardq+ fl_inter-
#            gemlist N20080602S 148-152 > bias0602.lis
#            gbias @bias0602.lis gN20080602S0148_bias.fits rawpath=rawdir$ fl_vardq+ fl_inter-
#            gemlist N20080607S 517-521 > bias0607.lis
#            gbias @bias0607.lis gN20080607S0517_bias.fits rawpath=rawdir$ fl_vardq+ fl_inter-
#            gemlist N20080621S 355,359 > bias0621.lis
#            gbias @bias0621.lis gN20080621S0355_bias.fits rawpath=rawdir$ fl_vardq+ fl_inter-
#            gemlist N20080703S 233-237 > bias0703.lis
#            gbias @bias0703.lis gN20080703S0233_bias.fits rawpath=rawdir$ fl_vardq+ fl_inter-


        ## Twilight - bias subtract
#            gemlist N20080602S 77-80 > twi0602.lis
#            gfreduce @twi0602.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080602S0148_bias.fits
#            gemlist N20080607S 494 > twi0607.lis
#            gfreduce @twi0607.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080607S0517_bias.fits

        ## Lick indices, flux standards, flats, CuAr arcs - bias subtract

#            gemlist N20080322S 49-52,54 > bs_0322.lis
#            gfreduce @bs_0322.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080322S0660_bias.fits

#            gemlist N20080602S 23,24,41-45,61-65 > bs_0602.lis
#            gfreduce @bs_0602.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080602S0148_bias.fits

#            gemlist N20080603S 120,121,124-128 > bs_0603.lis
#            gfreduce @bs_0603.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080602S0148_bias.fits

#            gemlist N20080607S 246,247,249,250,480-490 > bs_0607.lis
#            gfreduce @bs_0607.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080607S0517_bias.fits

#            gemlist N20080701S 91,90 > bs_0622.lis
#            gfreduce @bs_0622.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080621S0355_bias.fits

#            gemlist N20080702S 41-49 > bs_0702.lis
#            gfreduce @bs_0702.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080703S0233_bias.fits


        ## GALAXY science images - bias subtract
#            gemlist N20080602S 18-22 > gal1_0602.lis
#            gfreduce @gal1_0602.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080602S0148_bias.fits

#            gemlist N20080603S 117-119,122,123 > gal1_0603.lis
#            gfreduce @gal1_0603.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080602S0148_bias.fits

#            gemlist N20080607S 241-245,248 > gal2_0607.lis
#            gfreduce @gal2_0607.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080607S0517_bias.fits

#            gemlist N20080622S 44-47 > gal2_0622.lis
#            gfreduce @gal2_0622.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080621S0355_bias.fits

#            gemlist N20080701S 88,89,92 > gal2_0701.lis
#            gfreduce @gal2_0701.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080703S0233_bias.fits


    # Process the standards, EG131, and Lick Indices, HD102328, HD140283, HD201891
    # ----------------------------------------------------------------------------

        ## inputs: image, flat(s), arc(s)

        # GCal flats:
            # N20080322S0051 03-22
            # N20080602S0024,N20080602S0044,N20080602S0064 06-02
            # N20080603S0120,N20080603S0127 06-03
            # N20080607S0247,N20080607S0249,N20080607S0486,N20080607S0490 06-07
            # N20080622S0049 06-22
            # N20080702S0045,N20080702S0048 07-02

        # Lick indices
        # HD102328
            # N20080322S0049,N20080322S0052,N20080322S0054 03-22
            # N20080702S0041,N20080702S0042,N20080702S0043,N20080702S0044,N20080702S0049 07-02
        # HD140283
            # N20080602S0041,N20080602S0042,N20080602S0043 06-02
            # N20080603S0124,N20080603S0125,N20080603S0128 06-03
        # HD201891
            # N20080607S0481,N20080607S0482,N20080607S0483,N20080607S0484,N20080607S0485,N20080607S0488 06-07

        # Flux standards:
        # EG131
            # N20080602S0061,N20080602S0062,N20080602S0065 06-02

        # CuAr arcs:
            # N20080322S0050 03-22
            # N20080602S0023,N20080602S0045,N20080602S0063 06-02
            # N20080603S0121,N20080603S0126 06-03
            # N20080607S0246,N20080607S0250,N20080607S0487,N20080607S0489 06-07
            # N20080622S0050 06-22
            # N20080701S0091 07-01
            # N20080702S0047,N20080702S0048 07-02
print ('>>> here now')
        # 03-22
#        ifuproc_gqecorr rgN20080322S0049 rgN20080322S0051 rgN20080322S0050 twilight=rgN20080602S0077 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080322S0052 rgN20080322S0051 rgN20080322S0050 twilight=rgN20080602S0077 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080322S0054 rgN20080322S0051 rgN20080322S0050 twilight=rgN20080602S0077 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+

        # Run all the standards through ifuproc_qecorr via the script proc_sci which just iterates multiple science
        # files through given the same flats,arcs,twilights. Optional shift and calibration are turned off here.

        proc_sci rgN20080322S0049,rgN20080322S0052,rgN20080322S0054 flat=rgN20080322S0051 arc=rgN20080322S0050 \
            twilight=rgN20080602S0077

        # 06-02
#        ifuproc_gqecorr rgN20080602S0041 rgN20080602S0024,rgN20080602S0044,rgN20080602S0064 \
#            rgN20080602S0023,rgN20080602S0045,rgN20080602S0063 twilight=rgN20080602S0077 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080602S0042 rgN20080602S0024,rgN20080602S0044,rgN20080602S0064 \
#            rgN20080602S0023,rgN20080602S0045,rgN20080602S0063 twilight=rgN20080602S0077 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080602S0043 rgN20080602S0024,rgN20080602S0044,rgN20080602S0064 \
#            rgN20080602S0023,rgN20080602S0045,rgN20080602S0063 twilight=rgN20080602S0077 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080602S0061 rgN20080602S0024,rgN20080602S0044,rgN20080602S0064 \
#            rgN20080602S0023,rgN20080602S0045,rgN20080602S0063 twilight=rgN20080602S0077 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080602S0062 rgN20080602S0024,rgN20080602S0044,rgN20080602S0064 \
#            rgN20080602S0023,rgN20080602S0045,rgN20080602S0063 twilight=rgN20080602S0077 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080602S0065 rgN20080602S0024,rgN20080602S0044,rgN20080602S0064 \
#            rgN20080602S0023,rgN20080602S0045,rgN20080602S0063 twilight=rgN20080602S0077 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+

        # 06-03
#        ifuproc_gqecorr rgN20080603S0124 rgN20080603S0120,rgN20080603S0127 rgN20080603S0121,rgN20080603S0126 \
#            twilight=rgN20080602S0077 fl_inter=no bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080603S0125 rgN20080603S0120,rgN20080603S0127 rgN20080603S0121,rgN20080603S0126 \
#            twilight=rgN20080602S0077 fl_inter=no bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080603S0128 rgN20080603S0120,rgN20080603S0127 rgN20080603S0121,rgN20080603S0126 \
#            twilight=rgN20080602S0077 fl_inter=no bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+

        # 06-07
#        ifuproc_gqecorr rgN20080607S0481 rgN20080607S0247,rgN20080607S0249,rgN20080607S0486,rgN20080607S0490 \
#            rgN20080607S0246,rgN20080607S0250,rgN20080607S0487,rgN20080607S0489 twilight=rgN20080607S0494 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080607S0482 rgN20080607S0247,rgN20080607S0249,rgN20080607S0486,rgN20080607S0490 \
#            rgN20080607S0246,rgN20080607S0250,rgN20080607S0487,rgN20080607S0489 twilight=rgN20080607S0494 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080607S0483 rgN20080607S0247,rgN20080607S0249,rgN20080607S0486,rgN20080607S0490 \
#            rgN20080607S0246,rgN20080607S0250,rgN20080607S0487,rgN20080607S0489 twilight=rgN20080607S0494 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080607S0484 rgN20080607S0247,rgN20080607S0249,rgN20080607S0486,rgN20080607S0490 \
#            rgN20080607S0246,rgN20080607S0250,rgN20080607S0487,rgN20080607S0489 twilight=rgN20080607S0494 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080607S0485 rgN20080607S0247,rgN20080607S0249,rgN20080607S0486,rgN20080607S0490 \
#            rgN20080607S0246,rgN20080607S0250,rgN20080607S0487,rgN20080607S0489 twilight=rgN20080607S0494 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080607S0488 rgN20080607S0247,rgN20080607S0249,rgN20080607S0486,rgN20080607S0490 \
#            rgN20080607S0246,rgN20080607S0250,rgN20080607S0487,rgN20080607S0489 twilight=rgN20080607S0494 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+

        # 07-02
#        ifuproc_gqecorr rgN20080702S0041 rgN20080702S0045,rgN20080702S0048 rgN20080702S0047,rgN20080702S0048 \
#            twilight=rgN20080602S0077 fl_inter=no bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080702S0042 rgN20080702S0045,rgN20080702S0048 rgN20080702S0047,rgN20080702S0048 \
#            twilight=rgN20080602S0077 fl_inter=no bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080702S0043 rgN20080702S0045,rgN20080702S0048 rgN20080702S0047,rgN20080702S0048 \
#            twilight=rgN20080602S0077 fl_inter=no bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080702S0044 rgN20080702S0045,rgN20080702S0048 rgN20080702S0047,rgN20080702S0048 \
#            twilight=rgN20080602S0077 fl_inter=no bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        ifuproc_gqecorr rgN20080702S0049 rgN20080702S0045,rgN20080702S0048 rgN20080702S0047,rgN20080702S0048 \
#            twilight=rgN20080602S0077 fl_inter=no bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+


        ## Visually confirm proper reconstructed spectra
        gfdisplay steqpxbprgN20080702S0049.fits ver=1 z1=0 z2=1.e8

        ## Sum the stellar spectra

#        gfapsum steqpxbprgN20080322S0049.fits fl_inter-
#        gfapsum steqpxbprgN20080322S0052.fits fl_inter-
#        gfapsum steqpxbprgN20080322S0054.fits fl_inter-
#        gfapsum steqpxbprgN20080602S0041.fits fl_inter-
#        gfapsum steqpxbprgN20080602S0042.fits fl_inter-
#        gfapsum steqpxbprgN20080602S0043.fits fl_inter-
#        gfapsum steqpxbprgN20080602S0061.fits fl_inter-
#        gfapsum steqpxbprgN20080602S0062.fits fl_inter-
#        gfapsum steqpxbprgN20080602S0065.fits fl_inter-
#        gfapsum steqpxbprgN20080603S0124.fits fl_inter-
#        gfapsum steqpxbprgN20080603S0125.fits fl_inter-
#        gfapsum steqpxbprgN20080603S0128.fits fl_inter-
#        gfapsum steqpxbprgN20080607S0481.fits fl_inter-
#        gfapsum steqpxbprgN20080607S0482.fits fl_inter-
#        gfapsum steqpxbprgN20080607S0483.fits fl_inter-
#        gfapsum steqpxbprgN20080607S0484.fits fl_inter-
#        gfapsum steqpxbprgN20080607S0485.fits fl_inter-
#        gfapsum steqpxbprgN20080607S0488.fits fl_inter-
#        gfapsum steqpxbprgN20080702S0041.fits fl_inter-
#        gfapsum steqpxbprgN20080702S0042.fits fl_inter-
#        gfapsum steqpxbprgN20080702S0043.fits fl_inter-
#        gfapsum steqpxbprgN20080702S0044.fits fl_inter-
#        gfapsum steqpxbprgN20080702S0049.fits fl_inter-

        ## Combine the flux standards to calculate the flux calibration correction function

#        gscombine asteqpxbprgN20080602S0061.fits,asteqpxbprgN20080602S0062.fits,asteqpxbprgN20080602S0065.fits \
#            EG131_wl.fits logfile="gmos.log" combine="average" scale="mean" fl_vardq-

        ## Establish  spectrophotometric  calibration  for GMOS spectra
            ## correction curve should always be made interactively - avoid regions with strong absorption lines by
            ##       using keystroke commands to delete and add boxes away from the absorption lines
            ##   a: adds new bandpass, aa: make a box, d: deletes boxes closest to cusuror, q: quit

#        gsstandard EG131_wl.fits caldir="onedstds$ctionewcal/" extinction="gmos$calib/mkoextinct.dat" \
#            sfunction="sens_EG131_wl" sfile="std_EG131_wl"

        ## Visually inspect
        splot sens_jamesiraf_wl


    # Measure velocity difference between the two output slits using arcs - only done once
    # -------------------------------------------------------------------

        ## We have found small pixel offsets between the two pseudo slits that are not removed by the wavelength
        ## calibration. The reason for this is not understood but here is one workaround using the arc to determine the
        ## shift and then applying it to the science data.

        #   gftransform ergN20051205S0008.fits wavtraname=ergN20051205S0008
        #   gfxcor tergN20051205S0008.fits obs=Gemini-North
        #   tselect tergN20051205S0008.fits[mdf] slit1.fits "NO <= 750"
        #   tselect tergN20051205S0008.fits[mdf] slit2.fits "NO >= 751"
        #   tstat slit1.fits,slit2.fits SHIFT lowlim=-1000.0 highlim=1000.

        ## slit1.fits  SHIFT
        ##  749     0.01689319103      0.019838         0.012        -0.023         0.112
        ## slit2.fits  SHIFT
        ##  747      0.1320923696     0.0360886         0.134         0.034         0.204
        ##=0.132-0.017
        ##0.115

        #### calculate the shift - subtract the difference with gfshit and confirm the new shift ~0
        #   gfshift tergN20051205S0008.fits stergN20051205S0008.fits shift2=-0.115
        #   gfxcor stergN20051205S0008.fits obs=Gemini-North
        #   delete slit?.fits
        #   tselect stergN20051205S0008.fits[mdf] slit1.fits "NO <= 750"
        #   tselect stergN20051205S0008.fits[mdf] slit2.fits "NO >= 751"
        #   tstat slit1.fits,slit2.fits SHIFT lowlim=-1000.0 highlim=1000.

        ## slit1.fits  SHIFT
        ##  749     0.01689319103      0.019838         0.012        -0.023         0.112
        ## slit2.fits  SHIFT
        ##  747     0.02548995992     0.0365223         0.028        -0.073         0.098

#        calc_shift(ergN20080322S0050.fits, shift.fits)
#        calc_shift(ergN20080602S0023.fits, shift.fits)
#        calc_shift(ergN20080602S0045.fits, shift.fits)
#        calc_shift(ergN20080602S0063.fits, shift.fits)
#        calc_shift(ergN20080603S0121.fits, shift.fits)
#        calc_shift(ergN20080603S0126.fits, shift.fits)
#        calc_shift(ergN20080607S0246.fits, shift.fits)
#        calc_shift(ergN20080607S0250.fits, shift.fits)
#        calc_shift(ergN20080607S0487.fits, shift.fits)
#        calc_shift(ergN20080607S0489.fits, shift.fits)
#        calc_shift(ergN20080622S0050.fits, shift.fits)
#        calc_shift(ergN20080701S0091.fits, shift.fits)
#        calc_shift(ergN20080702S0047.fits, shift.fits)
#        calc_shift(ergN20080702S0048.fits, shift.fits)


    # Process the science
    # -------------------

    # Science images
    # HECJ125931.9+275140
        # N20080602S0018,N20080602S0019,N20080602S0020,N20080602S0021,N20080602S0022 06-02
        # N20080603S0117,N20080603S0118,N20080603S0119,N20080603S0122,N20080603S0123 06-03
    # HECJ130035.4+275633
        # N20080607S0241,N20080607S0242,N20080607S0243,N20080607S0244,N20080607S0245 06-07
        # N20080622S0044,N20080622S0045,N20080622S0046,N20080622S0047 06-22
        # N20080701S0088,N20080701S0089,N20080701S0092 07-01

        ## HECJ125931

#            ifuproc_gqecorr rgN20080602S0018 rgN20080602S0024,rgN20080602S0044,rgN20080602S0064 \
#                rgN20080602S0023,rgN20080602S0045,rgN20080602S0063 twilight=rgN20080602S0077 bkgmask=s0007_blkreg.dat \
#                fl_crspec+ fl_qecorr+ fl_skysub- fl_inter-
#            gfshift steqpxbprgN20051205S0006.fits hsteqpxbprgN20051205S0006.fits shift2=-0.112312670372
#            gscalibrate steqpxbprgN20051205S0006.fits extinction=gmos$calib/mkoextinct.dat fl_ext+ fl_vardq+ \
#                sfunction="sens_EG131_wl"
#            gfdisplay csteqpxbprgN20051205S0006.fits ver=1 z2=500 z1=0

#            proc_sci rgN20080602S0018 flat=rgN20080602S0024,rgN20080602S0044,rgN20080602S0064
#                arc=rgN20080602S0023,rgN20080602S0045,rgN20080602S0063 twilight=rgN20080602S0077 \
#                sens="sens_EG131_wl" shift=-0.112312670372 fl_calib+ fl_shift+



## Reorganise the data into 3D cubes - James' method
## ---------------------------------

# I SKIP THIS - Included because this is what James does
        #### SHOULD be using rvidlines to correct for any drifts in the wavelength zero point, since we're using
        #### a day-time arc. NOT yet sure how this works.
            ## rvidlines.coordlist="skylines.dat"
            ## rvidlines steqpxbprgN20051205S0006.fits[sky] threshold=7.
            ## rvidlines steqpxbprgN20051222S0108.fits[sky] threshold=7.
            ## rvidlines steqpxbprgN20051222S0112.fits[sky] threshold=7.
            ## rvidlines steqpxbprgN20051223S0121.fits[sky] threshold=7.
        #### Then, adjust the data prior to sky subtraction along with the final data to check how well the lines are registered
        #### CHANGE VALUES
            ## hedit teqpxbprgN20051205S0006.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit csteqpxbprgN20051205S0006.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit teqpxbprgN20051222S0108.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit csteqpxbprgN20051222S0108.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit teqpxbprgN20051222S0112.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit csteqpxbprgN20051222S0112.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit teqpxbprgN20051223S0121.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit csteqpxbprgN20051223S0121.fits[sci] CRVAL1 5618.164 upd+ ver-
        #### Then, sum over the WCS-corrected spectra & overplot (manually) for comparison
            ## improj teqpxbprgN20051205S0006[sci] t0006_sum projax=2 average-
            ## improj teqpxbprgN20051222S0108[sci] t0108_sum projax=2 average-
            ## improj teqpxbprgN20051222S0112[sci] t0112_sum projax=2 average-
            ## improj teqpxbprgN20051223S0121[sci] t0121_sum projax=2 average-

# DO THIS

    ## Resample to 3D with (minimal) atmospheric dispersion correction:
#    gfcube ("csteqpxbprgN20051205S0006.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("csteqpxbprgN20051222S0108.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("csteqpxbprgN20051222S0112.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("csteqpxbprgN20051223S0121.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)

    ## # Mosaic the datacubes:
#    pyfalign dcsteqpxbprgN20051205S0006,dcsteqpxbprgN20051222S0108,dcsteqpxbprgN20051222S0112,dcsteqpxbprgN20051223S0121 \
#       method="correlate"
#    pyfmosaic dcsteqpxbprgN20051205S0006,dcsteqpxbprgN20051222S0108,dcsteqpxbprgN20051222S0112,dcsteqpxbprgN20051223S0121 \
#        dcsteqpxbprgN20051205S0006_add separate- var+

# I STOP HERE - agian this is something James does that I don't

            ## Also make some cubes with sky lines included, to check for deterioration in FWHM after mosaicking:
        #    gfcube ("teqpxbprgN20051205S0006.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
        #    gfcube ("teqpxbprgN20051222S0108.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
        #    gfcube ("teqpxbprgN20051222S0112.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
        #    gfcube ("teqpxbprgN20051223S0121.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)


        ## CHANGE VALUES
            ## Give them the same offsets from pyfalign as the science cubes (after looking at the results from above):
        #    hedit dchsteqpxbprgN20051205S0006[sci] CRVAL1 64.99041999992549 upd+ ver-
        #    hedit dchsteqpxbprgN20051205S0006[sci] CRVAL2 0.04500000992549393 upd+ ver-
        #    hedit dchsteqpxbprgN20051222S0108[sci] CRVAL1 64.99041999992549 upd+ ver-
        #    hedit dchsteqpxbprgN20051222S0108[sci] CRVAL2 0.04500000992549393 upd+ ver-
        #    hedit dchsteqpxbprgN20051222S0112[sci] CRVAL1 65.48042000722705 upd+ ver-
        #    hedit dchsteqpxbprgN20051222S0112[sci] CRVAL2 0.04500000992549393 upd+ ver-
        #    hedit dchsteqpxbprgN20051223S0121[sci] CRVAL1 65.47042000707805 upd+ ver-
        #    hedit dchsteqpxbprgN20051223S0121[sci] CRVAL2 0.04500000992549393 upd+ ver-

            ## Mosaic the object + sky cubes: A quick imexam comparison with the first cube shows minimal if any
            ## degradation, with FWHM differences within 0.1-0.3 pix in both directions that look consistent with noise.
        #    pyfmosaic dcsteqpxbprgN20051205S0006,dcsteqpxbprgN20051222S0108,dcsteqpxbprgN20051222S0112,dcsteqpxbprgN20051223S0121 \
        #        dcsteqpxbprgN20051205S0006_add separate-


#### Gwen's method for making cubes
# ---------------------------------

    ## This is achieved with the task call 'call_cube.cl' which takes input (original file name, file extension number)

    ## Make sure to comment out 'gfcube' task in this script is already gfcube'd
#    make_cube.prefix="steqpxbprg"
#    make_cube ("N20051205S0006.fits", 006)
#    make_cube ("N20051222S0108.fits", 108)
#    make_cube ("N20051222S0112.fits", 112)
#    make_cube ("N20051223S0121.fits", 122)

## The output of this program is the fully shifted and combines cube - with both integer and decimal shifts.
## You may want to consider at this point cropping the final cubes in the spatial plane to remove the blank
##    sections added in the shift.

#    mkdir tmp_cal       # Make temporary folders to organise output - only if it does not exist already

#    align_cubes.prefix="steqpxbprg"         ## 'mdc' prefix will be added in where appropriate
#    align_cubes ("N20051205S0006", "006")
#    align_cubes ("N20051222S0108", "108")
#    align_cubes ("N20051222S0112", "112")
#    align_cubes ("N20051223S0121", "122")

    ## Combine the data cubes
#    dele calib_cubes_decimal.lis
#    print("amdcsteqpxbprgN20051205S0006_decimal.fits",>> "calib_cubes_decimal.lis")
#    print("amdcsteqpxbprgN20051222S0108_decimal.fits",>> "calib_cubes_decimal.lis")
#    print("amdcsteqpxbprgN20051222S0112_decimal.fits",>> "calib_cubes_decimal.lis")
#    print("amdcsteqpxbprgN20051223S0121_decimal.fits",>> "calib_cubes_decimal.lis")

#    dele calib_cubes_integer.lis
#    print("amdcsteqpxbprgN20051205S0006_integer.fits",>> "calib_cubes_integer.lis")
#    print("amdcsteqpxbprgN20051222S0108_integer.fits",>> "calib_cubes_integer.lis")
#    print("amdcsteqpxbprgN20051222S0112_integer.fits",>> "calib_cubes_integer.lis")
#    print("amdcsteqpxbprgN20051223S0121_integer.fits",>> "calib_cubes_integer.lis")

    ## First the decimal shifts
#    gscombine_new @calib_cubes_decimal.lis IC225_cal_decimal.fits logfile="gmos.log" combine="average" lthresh=-9999 fl_vard+
    ## The integer shifts
#    gscombine_new @calib_cubes_integer.lis IC225_cal_integer.fits logfile="gmos.log" combine="average" lthresh=-9999 fl_vard+

## To make 2D 'maps' fo the galaxy - use scrop to obtain a cube within the desired wavelength range, and then use
##    imcombine with 'project=yes' to flatten the cube inta a 2D image.

