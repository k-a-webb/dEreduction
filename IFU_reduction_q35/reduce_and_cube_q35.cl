# Written by Kristi Webb Aug 2015 for Gemini GMOS IFU program GN-2008A-Q-35

    # 03-22
        # N20080322S0049	HD102328		acq		    OBJECT	0.99931883812	MIRROR		4750.0
        # N20080322S0050	CuAr			progCal		ARC	    179.998117924	B600+_G5303	4780.0  Noisy, but looks ok
        # N20080322S0051	GCALflat		partnerCal	FLAT	79.9988541603	B600+_G5303	4780.0  Source is very faint
        # N20080322S0052	HD102328		progCal		OBJECT	119.998653889	B600+_G5303	4780.0  Source is very faint
        # N20080322S0054	HD102328		acq		    OBJECT	0.99961996078	MIRROR		4750.0
        # N20080322S0660	Bias			dayCal		BIAS	0.00050687789	MIRROR		6300.0
        # N20080322S0661	Bias			dayCal		BIAS	0.00053381919	MIRROR		6300.0
        # N20080322S0663	Bias			dayCal		BIAS	0.00050711631	MIRROR		6300.0
        # N20080322S0664	Bias			dayCal		BIAS	15.5886979103	MIRROR		6300.0
    # 06-02
        # N20080602S0018	HECJ125931.9+275140	acq		OBJECT	9.99924898148	MIRROR		4750.0
        # N20080602S0019	HECJ125931.9+275140	acq		OBJECT	59.999145031	MIRROR		4750.0
        # N20080602S0020	HECJ125931.9+275140	acq		OBJECT	59.9988231659	MIRROR		4750.0
        # N20080602S0021	HECJ125931.9+275140	science	OBJECT	2604.97747803	B600+_G5303	4820.0
        # N20080602S0022	HECJ125931.9+275140	science	OBJECT	2604.97733712	B600+_G5303	4820.0
        # N20080602S0023	CuAr			progCal		ARC	    179.998532057	B600+_G5303	4820.0
        # N20080602S0024	GCALflat		partnerCal	FLAT	79.9990489483	B600+_G5303	4820.0
        # N20080602S0041	HD140283		acqCal		OBJECT	0.99932003021	MIRROR		4750.0
        # N20080602S0042	HD140283		acqCal		OBJECT	0.99963307380	MIRROR		4750.0
        # N20080602S0043	HD140283		progCal		OBJECT	119.998664856	B600+_G5303	4820.0
        # N20080602S0044	GCALflat		partnerCal	FLAT	79.9990029335	B600+_G5303	4820.0
        # N20080602S0045	CuAr			progCal		ARC	    179.998157978	B600+_G5303	4820.0
        # N20080602S0061	EG131			acqCal		OBJECT	4.99959516525	MIRROR		4750.0
        # N20080602S0062	EG131			acqCal		OBJECT	9.99940800667	MIRROR		4750.0
        # N20080602S0063	CuAr			partnerCal	ARC	    179.998449087	B600+_G5303	4820.0
        # N20080602S0064	GCALflat		partnerCal	FLAT	79.9989459515	B600+_G5303	4820.0
        # N20080602S0065	EG131			partnerCal	OBJECT	179.998100042	B600+_G5303	4820.0
        # N20080602S0077	Twilight		dayCal		OBJECT	119.998550892	B600+_G5303	4820.0
        # N20080602S0078	Twilight		dayCal		OBJECT	19.9991369247	B600+_G5303	4820.0
        # N20080602S0079	Twilight		dayCal		OBJECT	59.9991738796	B600+_G5303	4820.0
        # N20080602S0080	Twilight		dayCal		OBJECT	119.998646021	B600+_G5303	4820.0
        # N20080602S0148	Bias			dayCal		BIAS	0.00051212310	B600+_G5303	6300.0
        # N20080602S0149	Bias			dayCal		BIAS	0.00052499771	B600+_G5303	6300.0
        # N20080602S0150	Bias			dayCal		BIAS	0.00052499771	B600+_G5303	6300.0
        # N20080602S0151	Bias			dayCal		BIAS	15.5887138844	B600+_G5303	6300.0
        # N20080602S0152	Bias			dayCal		BIAS	0.00051903724	B600+_G5303	6300.0
    # 06-03
        # N20080603S0117	HECJ125931.9+275140	acq		OBJECT	19.9994850159	MIRROR		4750.0
        # N20080603S0118	HECJ125931.9+275140	acq		OBJECT	59.9989929199	MIRROR		4750.0
        # N20080603S0119	HECJ125931.9+275140	acq		OBJECT	59.9991810322	MIRROR		4750.0
        # N20080603S0120	GCALflat		partnerCal	FLAT	79.9991121292	B600+_G5303	4780.0
        # N20080603S0121	CuAr			progCal		ARC	    179.998332977	B600+_G5303	4780.0
        # N20080603S0122	HECJ125931.9+275140	science	OBJECT	2604.98021698	B600+_G5303	4780.0   Source is very faint
        # N20080603S0123	HECJ125931.9+275140	science	OBJECT	2604.97828197	B600+_G5303	4780.0
        # N20080603S0124	HD140283		acqCal		OBJECT	0.99931383132	MIRROR		4750.0
        # N20080603S0125	HD140283		acqCal		OBJECT	0.99963498115	MIRROR		4750.0
        # N20080603S0126	CuAr			progCal		ARC 	179.998287916	B600+_G5303	4780.0
        # N20080603S0127	GCALflat		partnerCal	FLAT	79.9993751049	B600+_G5303	4780.0
        # N20080603S0128	HD140283		progCal		OBJECT	119.998781919	B600+_G5303	4780.0
    # 06-07
        # N20080607S0241	HECJ130035.4+275633	acq		OBJECT	9.99923801422	MIRROR		4750.0
        # N20080607S0242	HECJ130035.4+275633	acq		OBJECT	59.9990439415	MIRROR		4750.0
        # N20080607S0243	HECJ130035.4+275633	acq		OBJECT	119.998232841	MIRROR		4750.0
        # N20080607S0244	HECJ130035.4+275633	science	OBJECT	2604.97600293	B600+_G5303	4820.0
        # N20080607S0245	HECJ130035.4+275633	science	OBJECT	2604.97624612	B600+_G5303	4820.0
        # N20080607S0246	CuAr			progCal		ARC 	179.998077154	B600+_G5303	4820.0
        # N20080607S0247	GCALflat		partnerCal	FLAT	79.9988939762	B600+_G5303	4820.0
        # N20080607S0248	HECJ130035.4+275633	science	OBJECT	2604.97583222	B600+_G5303	4780.0  IQ issue
        # N20080607S0249	GCALflat		partnerCal	FLAT	79.9989080429	B600+_G5303	4780.0
        # N20080607S0250	CuAr			progCal		ARC 	179.998396158	B600+_G5303	4780.0
        # N20080607S0480	MT507			science		OBJECT	3.451	    	NO_GRATING	20900.0
        # N20080607S0481	HD201891		acqCal		OBJECT	0.999321937561	MIRROR		4750.0
        # N20080607S0482	HD201891		acqCal		OBJECT	0.999627113342	MIRROR		4750.0  Not guiding, wrong offset
        # N20080607S0483	HD201891		acqCal		OBJECT	0.999490022659	MIRROR		4750.0
        # N20080607S0484	HD201891		acqCal		OBJECT	0.999494075775	MIRROR		4750.0
        # N20080607S0485	HD201891		progCal		OBJECT	119.998605013	B600+_G5303	4820.0
        # N20080607S0486	GCALflat		partnerCal	FLAT	79.9989500046	B600+_G5303	4820.0
        # N20080607S0487	CuAr			progCal		ARC 	179.998332024	B600+_G5303	4820.0
        # N20080607S0488	HD201891		progCal		OBJECT	119.998594046	B600+_G5303	4780.0  some clouds, not great
        # N20080607S0489	CuAr			progCal		ARC 	179.998008966	B600+_G5303	4780.0
        # N20080607S0490	GCALflat		partnerCal	FLAT	79.9989571571	B600+_G5303	4780.0
        # N20080607S0494	Twilight		dayCal		OBJECT	119.998837948	B600+_G5303	4780.0
        # N20080607S0517	Bias			dayCal		BIAS	15.5887041092	B600+_G5303	6300.0
        # N20080607S0518	Bias			dayCal		BIAS	0.00049996376	B600+_G5303	6300.0
        # N20080607S0519	Bias			dayCal		BIAS	0.00049090385	B600+_G5303	6300.0
        # N20080607S0520	Bias			dayCal		BIAS	0.00052499771	B600+_G5303	6300.0
        # N20080607S0521	Bias			dayCal		BIAS	15.5887041092	B600+_G5303	6300.0
    # 06-21
        # N20080621S0355	Bias			dayCal		BIAS	15.5886881351	B600+_G5303	6300.0
        # N20080621S0356	Bias			dayCal		BIAS	0.00050282478	B600+_G5303	6300.0
        # N20080621S0357	Bias			dayCal		BIAS	15.5887138844	B600+_G5303	6300.0
        # N20080621S0358	Bias			dayCal		BIAS	15.5887210369	B600+_G5303	6300.0
        # N20080621S0359	Bias			dayCal		BIAS	0.00051498413	B600+_G5303	6300.0
    # 06-22
        # N20080622S0044	HECJ130035.4+275633	acq		OBJECT	59.9988660812	MIRROR		4750.0
        # N20080622S0045	HECJ130035.4+275633	acq		OBJECT	119.998421907	MIRROR		4750.0  entered wrong offsets
        # N20080622S0046	HECJ130035.4+275633	acq		OBJECT	119.999143124	MIRROR		4750.0
        # N20080622S0047	HECJ130035.4+275633	science	OBJECT	2214.37756014	B600+_G5303	4780.0
        # N20080622S0049	GCALflat		partnerCal	FLAT	79.9990739822	B600+_G5303	4780.0
        # N20080622S0050	CuAr			progCal		ARC	    179.998253822	B600+_G5303	4780.0  lost guiding at 85%
    # 07-01
        # N20080701S0088	HECJ130035.4+275633	acq		OBJECT	119.998411179	MIRROR		4750.0
        # N20080701S0089	HECJ130035.4+275633	acq		OBJECT	119.998231888	MIRROR		4750.0
        # N20080701S0090	GCALflat		partnerCal	FLAT	79.9989881516	B600+_G5303	4780.0
        # N20080701S0091	CuAr			progCal		ARC	    179.998068094	B600+_G5303	4780.0
        # N20080701S0092	HECJ130035.4+275633	science	OBJECT	2604.97592711	B600+_G5303	4780.0
    # 07-02
        # N20080702S0041	HD140283		acqCal		OBJECT	0.99963593483	MIRROR		4750.0
        # N20080702S0042	HD140283		acqCal		OBJECT	0.99962711334	MIRROR		4750.0
        # N20080702S0043	HD140283		acqCal		OBJECT	0.99949097633	MIRROR		4750.0
        # N20080702S0044	HD140283		progCal		OBJECT	119.998806  	B600+_G5303	4820.0
        # N20080702S0045	GCALflat		partnerCal	FLAT	79.9994249344	B600+_G5303	4820.0
        # N20080702S0046	CuAr			progCal		ARC	    179.998364925	B600+_G5303	4820.0
        # N20080702S0047	CuAr			progCal		ARC	    179.998686075	B600+_G5303	4780.0
        # N20080702S0048	GCALflat		partnerCal	FLAT	79.9991090298	B600+_G5303	4780.0
        # N20080702S0049	HD140283		progCal		OBJECT	119.999145985	B600+_G5303	4780.0
    # 07-03
        # N20080703S0233	Bias			dayCal		BIAS	15.5887420177	R150+_G5306	6300.0
        # N20080703S0234	Bias			dayCal		BIAS	0.00049495697	R150+_G5306	6300.0
        # N20080703S0235	Bias			dayCal		BIAS	0.00051689147	R150+_G5306	6300.0
        # N20080703S0236	Bias			dayCal		BIAS	0.00050401687	R150+_G5306	6300.0
        # N20080703S0237	Bias			dayCal		BIAS	0.00052189826	R150+_G5306	6300.0


## Aliases
## -------
set dd5=/Users/kwebb/IFU_reduction_q35/proc
set caldir=dd5$calib/
set rawdir=/net/sbfmaps/Volumes/Science/bmiller/bdisk/bmiller/coma_acs/GN-2008A-Q-35/raw/

set mygmos=/Users/kwebb/iraf/scripts/gmos/
set mypyfu=/Users/kwebb/iraf/extern/pyfu-0.8.1/
set jgmos=/Users/kwebb/iraf/extern/ifudrgmos/gmos/
directory.nc=1
set stdimage=imtgmos

reset gemini = /Users/kwebb/iraf/extern/ifudrgmos/
#task gemifudr.pkg = gemini$gemini.cl
redefine gemini.pkg = gemini$gemini.cl

# James' version of gemfix does not carry through the variance plane, use IRAF standard
task gemfix=/Users/kwebb/ur/ureka1.5.1/variants/common/iraf/gemini/gemtools/gemfix.cl

## Scripts
## -------
rv
onedspec
gemini
#nmisc
gmos
#pyfu

task mkmbpm=mygmos$mkmbpm.cl                # no standard
task gfshift=mygmos$gfshift.cl              # no standard
task gfxcor=mygmos$gfxcor.cl

# in pyraf
#reset pyfu = "/where/you/put/it/pyfu-0.8.1/"  # remember the trailing slash!
task pyfu.pkg = pyfu$pyfu.cl

task gscombine=/Users/kwebb/iraf/scripts/gwen/gscombine.cl
task gscombine_new=/Users/kwebb/iraf/scripts/gwen/gscombine_new.cl
task align_cubes=mygmos$align_cubes.cl
task make_cube=mygmos$make_cube.cl
task ifuproc_gqecorr=mygmos$ifuproc_gqecorr.cl
#task scrop=mygmos$scrop.cl
task scrop=/Users/kwebb/iraf/scripts/gwen/scrop.cl
task proc_sci=mygmos$proc_sci.cl

# Set one-off parameters reproducibly:
gfreduce.slits="both"
#gfreduce.exslits="*"
gfreduce.fl_nodshuffl=no
gfreduce.fl_inter=no
gfreduce.fl_vardq=yes
gfreduce.fl_addmdf=no
gfreduce.fl_over=no
gfreduce.fl_trim=no
gfreduce.fl_bias=no
#gfreduce.fl_qecorr=no                      # not yet implemented
gfreduce.fl_gscrrej=no
gfreduce.fl_gnsskysub=no
gfreduce.fl_extract=yes
gfreduce.fl_gsappwave=yes
gfreduce.fl_wavtran=yes
gfreduce.fl_skysub=no
gfreduce.fl_fluxcal=no
gfreduce.rawpath="rawdir$"
gfreduce.key_mdf=""
gfreduce.mdffile="default"
gfreduce.mdfdir="gmos$data/"
gfreduce.key_biassec="BIASSEC"
gfreduce.key_datasec="DATASEC"
gfreduce.bpmfile="gmos$data/chipgaps.dat"
#gfreduce.low_rej=3                         # not in bryans script
#gfreduce.high_rej=3                         # not in bryans script
#gfreduce.niter=5                         # not in bryans script
gfreduce.bias="gN20051204S0227_bias.fits"
gfreduce.reference=""
#gfreduce.qe_refim=""
gfreduce.response=""                        # Don't use this; do our own flat fielding
gfreduce.wavtraname=""
gfreduce.sfunction=""
gfreduce.extinction=""
gfreduce.fl_novlap=yes
gfreduce.perovlap=10.0
#gfreduce.nbiascontam="default"                         # not in bryans script
#gfreduce.biasrows="3:64"                         # not in bryans script
gfreduce.order=1

gfreduce.line=INDEF
gfreduce.nsum=10
gfreduce.trace=yes
gfreduce.recenter=yes
gfreduce.thresh=200.
gfreduce.t_order=21
gfreduce.t_nsum=10
gfreduce.gratingdb="gmos$data/GMOSgratings.dat"
gfreduce.filterdb="gmos$data/GMOSfilters.dat"
gfreduce.xoffset=INDEF
gfreduce.expr="default"
gfreduce.observatory="default"
gfreduce.logfile=""
gfreduce.verbose=yes

# Parameter's that James uses
gfreduce.function="spline3"                 # defulat: chebyshev
gfreduce.order=1                            # defulat: 5
gfreduce.weights="none"                     # defulat: variance
#gfreduce.grow=1.5                           # defulat: 1                         # not in bryans script
#gfreduce.fl_fixgaps=yes                     # defulat: no                         # not in bryans script

gbias.logfile=""
gbias.rawpath="rawdir$"
gbias.fl_over=yes
gbias.fl_trim=yes
gbias.key_biassec="BIASSEC"
gbias.key_datasec="DATASEC"
gbias.bpm=""
gbias.sat="default"
gbias.nbiascontam="default"
gbias.biasrows="default"
gbias.fl_inter=yes
gbias.median=no
gbias.function="chebyshev"
gbias.order=1
gbias.low_reject=2.0                        # overscan
gbias.high_reject=2.0
gbias.order=1
gbias.niter=11
gbias.combine="average"
gbias.reject="avsigclip"
gbias.lthreshold=INDEF
gbias.hthreshold=INDEF
gbias.masktype="goodvalue"
gbias.maskvalue=0.0
gbias.scale="none"
gbias.zero="none"
gbias.weight="none"
gbias.statsec="[*,*]"
gbias.mclip=yes
gbias.lsigma=2.0                            # combine
gbias.hsigma=2.0
gbias.fl_vardq=yes
gbias.verbose=yes

gswavelength.dispaxis=1
#gswavelength.coordlist="IFU_example_data/cuar.dat"
gswavelength.section="middle line"
gswavelength.nsum=1
gswavelength.ftype="emission"
gswavelength.fwidth=10.0
gswavelength.gsigma=0.0
gswavelength.cradius=10.0
gswavelength.nlost=10
gswavelength.minsep=2.5
gswavelength.refit=yes
gswavelength.step=1
gswavelength.trace=yes
gswavelength.low_rej=2.5
gswavelength.high_rej=2.5
gswavelength.fl_addfeat=yes
gswavelength.aiddebug="s"
gswavelength.fl_dbwrite="YES"
gswavelength.fl_overwrite=yes

gfscatsub.outimage=""
gfscatsub.prefix="b"
gfscatsub.xorder="5,9,5"                    # try 5,5,9,5,5,5 for new GMOS-N CCDs
gfscatsub.yorder="5,7,5"                    # try 5,5,9,5,5,5 for new GMOS-N CCDs
gfscatsub.cross=yes

# Mainly defaults for the record, not set by gfreduce
#gemcrspec.xorder=9
#gemcrspec.yorder=-1
#gemcrspec.sigclip=4.5                       # Sometimes needs changing for higher-contrast data
#gemcrspec.sigfrac=0.32                      # 1.4 sigma is 84%
#gemcrspec.objlim=1.0
#gemcrspec.niter=5
#gemcrspec.fl_vardq=yes
#gemcrspec.logfile="example.log"
#gemcrspec.verbose=yes

gfskysub.outimages=""
gfskysub.outpref="s"
gfskysub.expr="default"                     # same as gfreduce default
gfskysub.combine="average"
gfskysub.reject="avsigclip"
gfskysub.scale="none"
gfskysub.zero="none"
gfskysub.weight="none"
gfskysub.lthreshold=INDEF
gfskysub.hthreshold=INDEF
gfskysub.lsigma=3.0
gfskysub.hsigma=3.0
gfskysub.fl_inter=no

#rvidlines.observatory="gemini-north"       # remember to change throughout for GS!
rvidlines.nsum=1
rvidlines.maxfeatures=10
rvidlines.ftype="emission"
rvidlines.fwidth=10.
rvidlines.cradius=10.
rvidlines.threshold=10.
rvidlines.minsep=5.
rvidlines.logfile="rvid.log"

#gemfix.grow=1.5
#gemfix.bitmask=65535
#gemfix.axis=1
#gemfix.order=0
#gemfix.low_reject=3.0
#gemfix.high_reject=2.3
#gemfix.niterate=5

gfextract.fl_vardq=yes

## Use bpms for the appropriate binning, mbpm is created from the others
ifuproc_gqecorr.mbpm="gn_bpm2x1m.fits"
ifuproc_gqecorr.bpm1="mygmos$bpms/gn_bpm_ccd1_1x1f.pl"
ifuproc_gqecorr.bpm2="mygmos$bpms/gn_bpm_ccd2_1x1f.pl"
ifuproc_gqecorr.bpm3="mygmos$bpms/gn_bpm_ccd3_1x1f.pl"
ifuproc_gqecorr.weights="none"
ifuproc_gqecorr.bpmgaps="gmos$data/chipgaps.dat"    # Width of chip gap and feature width, this data is 2x1
ifuproc_gqecorr.gap12=19
ifuproc_gqecorr.gap23=19
ifuproc_gqecorr.fwidth=2.


# Notes:
# ------
# ifuproc works best in pyraf:
#   the standard gftransform does not work in pyraf as there's an issue with the variable 'scilistout'
# Make sure to change the task definition above depending on environment


# Preliminary reduction
# ---------------------

## This step includes all the commands necessary to reduce the data, but not all steps are automated.
## The main task not automated is the veolcity shift correction. It is still required to interactively determine
##     the velocity shift based on the two arcs, and to correct the data in the opposite way to the arcs.
## Tasks which have been run previously have been commented out with a single #

    # Prepare the bias, twilights, flux standars, and science images
    # --------------------------------------------------------------

        ## Biases - make list for each observation date, combine
#            gemlist N20080602S 148-152 > bias0602.lis
#            gbias @bias0602.lis gN20080602S0148_bias.fits rawpath=rawdir$ fl_vardq+ fl_inter-
#            gemlist N20080607S 517-521 > bias0607.lis
#            gbias @bias0607.lis gN20080607S0517_bias.fits rawpath=rawdir$ fl_vardq+ fl_inter-
#            gemlist N20080621S 355,359 > bias0621.lis
#            gbias @bias0621.lis gN20080621S0355_bias.fits rawpath=rawdir$ fl_vardq+ fl_inter-
#            gemlist N20080703S 233-237 > bias0703.lis
#            gbias @bias0703.lis gN20080703S0233_bias.fits rawpath=rawdir$ fl_vardq+ fl_inter-

        ## Lick indices, flux standards, flats, CuAr arcs - bias subtract

#            gemlist N20080322S 50-52 > bs_0322.lis
#            gfreduce @bs_0322.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080602S0148_bias.fits

#            gemlist N20080602S 23,24,43-45,63-65 > bs_0602.lis
#            imdel g@bs_0602.lis,rg@bs_0602.lis
#            gfreduce @bs_0602.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080602S0148_bias.fits

#            gemlist N20080603S 120,121,126-128 > bs_0603.lis
#            imdel g@bs_0603.lis,rg@bs_0603.lis
#            gfreduce @bs_0603.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080602S0148_bias.fits

#            gemlist N20080607S 246,247,249,250,485-490 > bs_0607.lis
#            imdel g@bs_0607.lis,rg@bs_0607.lis
#            gfreduce @bs_0607.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080607S0517_bias.fits

            gemlist N20080622S 50,49 > bs_0622.lis
            imdel g@bs_0622.lis,rg@bs_0622.lis
            gfreduce @bs_0622.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
                fl_addmdf+ bias=gN20080621S0355_bias.fits

            gemlist N20080701S 90,91 > bs_0701.lis
            imdel g@bs_0701.lis,rg@bs_0701.lis
            gfreduce @bs_0701.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
                fl_addmdf+ bias=gN20080703S0233_bias.fits

            gemlist N20080702S 44-49 > bs_0702.lis
            imdel g@bs_0702.lis,rg@bs_0702.lis
            gfreduce @bs_0702.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
                fl_addmdf+ bias=gN20080703S0233_bias.fits


        ## GALAXY science images - bias subtract
            gemlist N20080602S 21-22 > gal1_0602.lis
#            gfreduce @gal1_0602.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080602S0148_bias.fits

            gemlist N20080603S 122,123 > gal1_0603.lis
#            gfreduce @gal1_0603.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080602S0148_bias.fits

            gemlist N20080607S 244-245,248 > gal2_0607.lis
#            gfreduce @gal2_0607.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080607S0517_bias.fits

            gemlist N20080622S 47 > gal2_0622.lis
#            gfreduce @gal2_0622.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080621S0355_bias.fits

            gemlist N20080701S 92 > gal2_0701.lis
            imdel g@gal2_0701.lis,rg@gal2_0701.lis
            gfreduce @gal2_0701.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
                fl_addmdf+ bias=gN20080703S0233_bias.fits


        # 03-22
            gemlist N20080322S 50-52 > spc_0322.lis
#            gfreduce @spc_0322.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080602S0148_bias.fits

        # 06-02
            gemlist N20080602S 21-24,43-45,63-65 > spc_0602.lis
#            gfreduce @spc_0602.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080602S0148_bias.fits

        # 06-03
            gemlist N20080603S 120-123,126-128 > spc_0603.lis
#            gfreduce @spc_0603.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080602S0148_bias.fits

        # 06-07
            gemlist N20080607S 244-250,485-490 > spc_0607.lis
#            gfreduce @spc_0607.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080607S0517_bias.fits

        # 06-22
            gemlist N20080622S 47,49,50 > spc_0622.lis
#            gfreduce @spc_0622.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080621S0355_bias.fits

        # 07-01
            gemlist N20080701S 90-92 > spc_0701.lis
#            gfreduce @spc_0701.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080703S0233_bias.fits

        # 07-02
            gemlist N20080702S 44-49 > spc_0702.lis
#            gfreduce @spc_0702.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20080703S0233_bias.fits




    # Process the standards, EG131, and Lick Indices, HD102328, HD140283, HD201891
    # ----------------------------------------------------------------------------

        ## inputs: image, flat(s), arc(s)

    # 03-22
#        ifuproc_gqecorr rgN20080322S0052 rgN20080322S0051 rgN20080322S0050 twilight="" fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+

        ## Visually confirm proper reconstructed spectra
#        gfdisplay steqpxbprgN20080322S0052.fits ver=1 z1=0 z2=1.e8

        ## Sum the stellar spectra
#        gfapsum steqpxbprgN20080322S0052.fits fl_inter-

    # 06-02
        ifuproc_gqecorr rgN20080602S0043 rgN20080602S0044 rgN20080602S0045 twilight="" fl_inter=no \
            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        gfapsum steqpxbprgN20080602S0043.fits fl_inter-
        ifuproc_gqecorr rgN20080602S0065 rgN20080602S0064 rgN20080602S0063 twilight="" fl_inter=no \
            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        gfapsum steqpxbprgN20080602S0065.fits fl_inter-

    # 06-03
        ifuproc_gqecorr rgN20080603S0128 rgN20080603S0127 rgN20080603S0126 \
            fl_inter- bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+ twilight=""
#        gfapsum steqpxbprgN20080603S0128.fits fl_inter-

    # 06-07
        ifuproc_gqecorr rgN20080607S0485 rgN20080607S0486 rgN20080607S0487 twilight="" fl_inter=no \
            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        gfapsum steqpxbprgN20080607S0485.fits fl_inter-
        ifuproc_gqecorr rgN20080607S0488 rgN20080607S0489 rgN20080607S0490 twilight="" fl_inter=no \
            bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+
#        gfapsum steqpxbprgN20080607S0488.fits fl_inter-

    # 07-02
        ifuproc_gqecorr rgN20080702S0044 N20080702S0045 rgN20080702S0046 \
            fl_inter- bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+ twilight=""
#        gfapsum steqpxbprgN20080702S0044.fits fl_inter-
        ifuproc_gqecorr rgN20080702S0049 rgN20080702S0048 rgN20080702S0047 \
            fl_inter- bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+ fl_apsum+ twilight=""
#        gfapsum steqpxbprgN20080702S0049.fits fl_inter-


        ## Combine the flux standards to calculate the flux calibration correction function

#        gscombine asteqpxbprgN20080322S0052.fits,asteqpxbprgN20080602S0043.fits,asteqpxbprgN20080602S0065.fits,asteqpxbprgN20080603S0128.fits,asteqpxbprgN20080607S0485.fits,asteqpxbprgN20080607S0488.fits,asteqpxbprgN20080702S0044.fits,asteqpxbprgN20080702S0049.fits \
#            EG131_wl.fits logfile="gmos.log" combine="average" scale="mean" fl_vardq-

        ## Establish  spectrophotometric  calibration  for GMOS spectra
            ## correction curve should always be made interactively - avoid regions with strong absorption lines by
            ##       using keystroke commands to delete and add boxes away from the absorption lines
            ##   a: adds new bandpass, aa: make a box, d: deletes boxes closest to cusuror, q: quit

#        gsstandard EG131_wl.fits caldir="onedstds$ctionewcal/" extinction="gmos$calib/mkoextinct.dat" \
#            sfunction="sens_EG131_wl" sfile="std_EG131_wl"

        ## Visually inspect
#        splot sens_EG131_wl


    # Measure velocity difference between the two output slits using arcs - only done once
    # -------------------------------------------------------------------

        ## We have found small pixel offsets between the two pseudo slits that are not removed by the wavelength
        ## calibration. The reason for this is not understood but here is one workaround using the arc to determine the
        ## shift and then applying it to the science data.

        #   gftransform ergN20051205S0008.fits wavtraname=ergN20051205S0008
        #   gfxcor tergN20051205S0008.fits obs=Gemini-North
        #   tselect tergN20051205S0008.fits[mdf] slit1.fits "NO <= 750"
        #   tselect tergN20051205S0008.fits[mdf] slit2.fits "NO >= 751"
        #   tstat slit1.fits,slit2.fits SHIFT lowlim=-1000.0 highlim=1000.

            ## slit1.fits  SHIFT
            ##  749     0.01689319103      0.019838         0.012        -0.023         0.112
            ## slit2.fits  SHIFT
            ##  747      0.1320923696     0.0360886         0.134         0.034         0.204
            ##=0.132-0.017
            ##0.115

        #### calculate the shift - subtract the difference with gfshit and confirm the new shift ~0
        #   gfshift tergN20051205S0008.fits stergN20051205S0008.fits shift2=-0.115
        #   gfxcor stergN20051205S0008.fits obs=Gemini-North
        #   delete slit?.fits
        #   tselect stergN20051205S0008.fits[mdf] slit1.fits "NO <= 750"
        #   tselect stergN20051205S0008.fits[mdf] slit2.fits "NO >= 751"
        #   tstat slit1.fits,slit2.fits SHIFT lowlim=-1000.0 highlim=1000.

            ## slit1.fits  SHIFT
            ##  749     0.01689319103      0.019838         0.012        -0.023         0.112
            ## slit2.fits  SHIFT
            ##  747     0.02548995992     0.0365223         0.028        -0.073         0.098

#        calc_shift(ergN20080322S0050.fits, shift.fits)
#        calc_shift(ergN20080602S0045.fits, shift.fits)
#        calc_shift(ergN20080602S0063.fits, shift.fits)
#        calc_shift(ergN20080603S0126.fits, shift.fits)
#        calc_shift(ergN20080607S0487.fits, shift.fits)
#        calc_shift(ergN20080607S0490.fits, shift.fits)
#        calc_shift(ergN20080702S0046.fits, shift.fits)
#        calc_shift(ergN20080702S0047.fits, shift.fits)


    # Process the science
    # -------------------

    # 06-02
#        proc_sci N20080602S0021,N20080602S0022 flat=rgN20080602S0024 arc=rgN20080602S0023 twilight="" \
#            sens="sens_EG131_wl" shift=-0. fl_calib+ fl_shift+

#        gfshift steqpxbprgN20051205S0006.fits hsteqpxbprgN20051205S0006.fits shift2=-0.
#        gscalibrate steqpxbprgN20051205S0006.fits extinction=gmos$calib/mkoextinct.dat fl_ext+ fl_vardq+ \
#            sfunction="sens_EG131_wl"
#        gfdisplay csteqpxbprgN20051205S0006.fits ver=1 z2=500 z1=0

    # 06-03
#        proc_sci rgN20080603S0122,rgN20080603S0123 flat=rgN20080603S0120 arc=rgN20080603S0121 twilight="" \
#            sens="sens_EG131_wl" shift=-0. fl_calib+ fl_shift+

    # 06-07
#        proc_sci rgN20080607S0244,rgN20080607S0245 flat=rgN20080607S0247 arc=rgN20080607S0246 twilight="" \
#            sens="sens_EG131_wl" shift=-0. fl_calib+ fl_shift+

    # 06-22
#        proc_sci rgN20080622S0047 flat=rgN20080622S0049 arc=rgN20080622S0050 twilight="" \
#            sens="sens_EG131_wl" shift=-0. fl_calib+ fl_shift+

    # 07-01
#        proc_sci rgN20080701S0092 flat=rgN20080701S0090 arc=rgN20080701S0091 twilight="" \
#            sens="sens_EG131_wl" shift=-0. fl_calib+ fl_shift+



## Reorganise the data into 3D cubes - James' method
## ---------------------------------

# I SKIP THIS - Included because this is what James does
        #### SHOULD be using rvidlines to correct for any drifts in the wavelength zero point, since we're using
        #### a day-time arc. NOT yet sure how this works.
            ## rvidlines.coordlist="skylines.dat"
            ## rvidlines steqpxbprgN20051205S0006.fits[sky] threshold=7.
            ## rvidlines steqpxbprgN20051222S0108.fits[sky] threshold=7.
            ## rvidlines steqpxbprgN20051222S0112.fits[sky] threshold=7.
            ## rvidlines steqpxbprgN20051223S0121.fits[sky] threshold=7.
        #### Then, adjust the data prior to sky subtraction along with the final data to check how well the lines are registered
        #### CHANGE VALUES
            ## hedit teqpxbprgN20051205S0006.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit csteqpxbprgN20051205S0006.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit teqpxbprgN20051222S0108.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit csteqpxbprgN20051222S0108.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit teqpxbprgN20051222S0112.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit csteqpxbprgN20051222S0112.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit teqpxbprgN20051223S0121.fits[sci] CRVAL1 5618.164 upd+ ver-
            ## hedit csteqpxbprgN20051223S0121.fits[sci] CRVAL1 5618.164 upd+ ver-
        #### Then, sum over the WCS-corrected spectra & overplot (manually) for comparison
            ## improj teqpxbprgN20051205S0006[sci] t0006_sum projax=2 average-
            ## improj teqpxbprgN20051222S0108[sci] t0108_sum projax=2 average-
            ## improj teqpxbprgN20051222S0112[sci] t0112_sum projax=2 average-
            ## improj teqpxbprgN20051223S0121[sci] t0121_sum projax=2 average-

# DO THIS

    ## Resample to 3D with (minimal) atmospheric dispersion correction:
#    gfcube ("chsteqpxbprgN20080602S0021.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("chsteqpxbprgN20080602S0022.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("chsteqpxbprgN20080603S0122.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("chsteqpxbprgN20080603S0123.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("chsteqpxbprgN20080607S0244.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("chsteqpxbprgN20080607S0245.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("chsteqpxbprgN20080622S0047.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("chsteqpxbprgN20080701S0092.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)

    ## # Mosaic the datacubes:
    # HECJ125931.9+275140
#    pyfalign dchsteqpxbprgN20080602S0021,dchsteqpxbprgN20080602S0022,dchsteqpxbprgN20080603S0122,dchsteqpxbprgN20080603S0123 \
#       method="correlate"
#    pyfmosaic dchsteqpxbprgN20080602S0021,dchsteqpxbprgN20080602S0022,dchsteqpxbprgN20080603S0122,dchsteqpxbprgN20080603S0123 \
#        HECJ125931_cube separate- var+

    # HECJ130035.4+275633
#    pyfalign dchsteqpxbprgN20080607S0244,chsteqpxbprgN20080607S0245,dchsteqpxbprgN20080622S0047,dchsteqpxbprgN20080701S0092 \
#       method="correlate"
#    pyfmosaic dchsteqpxbprgN20080607S0244,chsteqpxbprgN20080607S0245,dchsteqpxbprgN20080622S0047,dchsteqpxbprgN20080701S0092 \
#        HECJ130035_cube separate- var+

# I STOP HERE - agian this is something James does that I don't

            ## Also make some cubes with sky lines included, to check for deterioration in FWHM after mosaicking:
        #    gfcube ("teqpxbprgN20051205S0006.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
        #    gfcube ("teqpxbprgN20051222S0108.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
        #    gfcube ("teqpxbprgN20051222S0112.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
        #    gfcube ("teqpxbprgN20051223S0121.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)


        ## CHANGE VALUES
            ## Give them the same offsets from pyfalign as the science cubes (after looking at the results from above):
        #    hedit dchsteqpxbprgN20051205S0006[sci] CRVAL1 64.99041999992549 upd+ ver-
        #    hedit dchsteqpxbprgN20051205S0006[sci] CRVAL2 0.04500000992549393 upd+ ver-
        #    hedit dchsteqpxbprgN20051222S0108[sci] CRVAL1 64.99041999992549 upd+ ver-
        #    hedit dchsteqpxbprgN20051222S0108[sci] CRVAL2 0.04500000992549393 upd+ ver-
        #    hedit dchsteqpxbprgN20051222S0112[sci] CRVAL1 65.48042000722705 upd+ ver-
        #    hedit dchsteqpxbprgN20051222S0112[sci] CRVAL2 0.04500000992549393 upd+ ver-
        #    hedit dchsteqpxbprgN20051223S0121[sci] CRVAL1 65.47042000707805 upd+ ver-
        #    hedit dchsteqpxbprgN20051223S0121[sci] CRVAL2 0.04500000992549393 upd+ ver-

            ## Mosaic the object + sky cubes: A quick imexam comparison with the first cube shows minimal if any
            ## degradation, with FWHM differences within 0.1-0.3 pix in both directions that look consistent with noise.
        #    pyfmosaic dcsteqpxbprgN20051205S0006,dcsteqpxbprgN20051222S0108,dcsteqpxbprgN20051222S0112,dcsteqpxbprgN20051223S0121 \
        #        dcsteqpxbprgN20051205S0006_add separate-