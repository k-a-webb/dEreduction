# Origanlly written by Bryan Miller and reduction steps by Gwen Rudie
# Edited by Kristi Webb May 2015

## 2005dec03
#GN-2005B-DD-5-3    16:20:39    1            239           Twilight               g        B600/478.0  IFU             300            full
#GN-2005B-DD-5-3    not quite enough counts, redo junk
#GN-2005B-DD-5-3    16:29:20    2            240           Twilight               g        B600/478.0  IFU             400            full
#GN-2005B-DD-5-3    35000 cts max ok
#GN-2005B-DD-5-3    16:38:00    3            241           Twilight               g        B600/482    IFU             120            full

## 2005dec04
#GN-CAL20051204-3  16:56:25    11-15        227-231       Bias         none     mirror     none  0.0            full

## 2005dec05
#GN-2005B-DD-5-2   04:28:42    1            1             IC225        g        mirror      none            10.0           ccd2
#GN-2005B-DD-5-2   p=27.6 q=-2.01
#GN-2005B-DD-5-2   04:33:08    2            2             IC225        g        mirror      IFU             60             full
#GN-2005B-DD-5-2   p=0.875, q=-0.33
#GN-2005B-DD-5-2   04:39:37    3            3             IC225        g        mirror      IFU             60             full
#GN-2005B-DD-5-2   centered on the midpoint btw the 2 nuclei
#GN-2005B-DD-5-1   04:43:50    1-2          4-5           CuAr         g        B600/478.0  IFU             120.0          full
#GN-2005B-DD-5-1   Junk
#GN-2005B-DD-5-1   04:52:05    3            6             IC225        g        B600/478.0  IFU             3300.0         full
#GN-2005B-DD-5-1   ok
#GN-2005B-DD-5-1   05:49:52    4            7             GCALflat     g        B600/478.0  IFU             40.0           full
#GN-2005B-DD-5-1   ok
#GN-2005B-DD-5-1   05:52:12    5            8             CuAr         g        B600/478.0  IFU             120.0          full
#GN-2005B-DD-5-1   ok

## 2005dec06
#GN-2005B-DD-5-4            11:51:59    1            124           Hiltner600   g        mirror      none  1              ccd2
#   testing seeing (unable to guide with guide star, switched to the brighter target for test)
#   ok
#GN-2005B-DD-5-4            11:55:34    2-3          125-126       Hiltner600   g        mirror      none  10             ccd2
#   ok
#   starting acquistion (guiding on correct star)
#GN-2005B-DD-5-4            12:05:49    4            127           Hiltner600   g        mirror      IFU   2              full
#   ok
#GN-2005B-DD-5-4            12:12:00    5-7          128-130       Hiltner600   g        mirror      IFU   2              full
#   ok
#   do not see  lower fiber bundle, but have centered star
#GN-2005B-DD-5-5            12:21:23    1-2          131-132       Hiltner600   g        B600/478.0  IFU   160.0          full
#   junk, lost guiding
#   ok, exptime 160
#GN-2005B-DD-5-5            12:36:39    3            133           Hiltner600   g        B600/478.0  IFU   300            full
#   ok, exptime 300
#GN-2005B-DD-5-5            12:46:42    4            134           Hiltner600   g        B600/478.0  IFU   400            full
#   ok, exptime 400
#GN-2005B-DD-5-5            12:56:10    5            135           GCALflat     g        B600/478.0  IFU   40.0           full
#   ok
#GN-2005B-DD-5-6            13:23:30    1            136           Hiltner600   g        mirror      none  10             ccd2
#   ok
#GN-2005B-DD-5-5            14:37:12    6            138           CuAr         g        B600/478.0  IFU   120.0          full
#   ok

## 2005dec20
#GN-CAL20051220-6  16:36:44    11-15        228-232       Bias         none     mirror     none  0.0            full

## 2005dec22
#GN-2005B-DD-5-2   06:42:26    4            103           IC225        g        mirror      none       10.0           ccd2
#GN-2005B-DD-5-2   06:51:19    5            104           IC225        g        mirror      IFU        60             full
#GN-2005B-DD-5-2   06:55:33    6            105           IC225        g        mirror      IFU        60             full
#GN-2005B-DD-5-1   06:59:30    6            106           CuAr         g        B600/482.0  IFU        120.0          full
#GN-2005B-DD-5-1   07:02:58    7            107           GCALflat     g        B600/482.0  IFU        40.0           full
#GN-2005B-DD-5-1   07:05:16    8            108           IC225        g        B600/482.0  IFU        3300.0         full
#GN-2005B-DD-5-1   08:01:54    9            109           CuAr         g        B600/482.0  IFU        120.0          full
#GN-2005B-DD-5-1   08:05:36    10-11        110-111       CuAr         g        B600/478.0  IFU        120.0          full
#GN-2005B-DD-5-1   08:12:35    12           112           IC225        g        B600/478.0  IFU        3300.0         full
#GN-2005B-DD-5-1   09:09:13    13           113           GCALflat     g        B600/478.0  IFU        40.0           full
#GN-2005B-DD-5-1   09:11:21    14           114           CuAr         g        B600/478.0  IFU        120.0          full

## 2005dec23
#GN-2005B-DD-5-2  06:42:20    7            116           IC225        g        mirror     none  10.0           ccd2
#GN-2005B-DD-5-2  06:57:01    8            117           IC225        g        mirror     IFU   60             full
#GN-2005B-DD-5-2  07:02:47    9            118           IC225        g        mirror     IFU   60             full

##Entries for images 119-122 missing, added manually from headers
#GN-2005B-DD-5-1   07:07:36    15            119           CuAr         g        B600/482.0  IFU        120.0          full
#GN-2005B-DD-5-1   07:11:04    16            120           GCALflat     g        B600/482.0  IFU        40.0           full
#GN-2005B-DD-5-1   07:13:23    17            121           IC225        g        B600/482.0  IFU        3300.0         full
#GN-2005B-DD-5-1   08:10:01    18            122           CuAr         g        B600/482.0  IFU        120.0          full

## Aliases
## -------
set dd5=/Users/kwebb/IFU_reduction/proc
set caldir=dd5$calib/
set rawdir=/net/sbfmaps/Volumes/Science/bmiller/bdisk/bmiller/GN-2005B-DD-5/raw/

set mygmos=/Users/kwebb/iraf/scripts/gmos/
#set mygmos=/data1/kwebb/gemini/iraf/scripts/gmos/      # oringal file structure, changed for MacOSX path names
directory.nc=1

## Scripts
## -------
rv
onedspec
gemini
nmisc
#gemlocal   # not required
gmos
#task gscrspec=mygmos$gscrspec.cl
#task specx2w=mygmos$specx2w.cl     # not required
#task wrbox=mygmos$wrbox.cl
#task gspecshift=mygmos$gspecshift.cl
#task findgaps=mygmos$findgaps.cl
#task fndblocks=mygmos$fndblocks.cl
#task qecorr=mygmos$qecorr.cl
#task ifuproc=mygmos$ifuproc.cl
#task gfreduce=mygmos$gfreduce.cl        # USE STANDARD
#task gfextract=mygmos$gfextract.cl     # USE STANDARD
#task gftransform=mygmos$gftransform.cl     # to run in pyraf, uncomment, to run in iraf comment out
#task gfresponse=mygmos$gfresponse.cl
#task gfskysub=mygmos$gfskysub.cl
#task gfbkgsub=mygmos$gfbkgsub.cl
#task gfdisplay=gmos$gfdisplay.cl
#task gscombine=mygmos$gscombine.cl
#task gscalibrate=mygmos$gscalibrate.cl
#task chkblocks=mygmos$chkblocks.cl
#task gkeywpars=mygmos$gkeywpars.cl
#task gfshift=mygmos$gfshift.cl
#task gfxcor=mygmos$gfxcor.cl
task mkmbpm=mygmos$mkmbpm.cl

task align_cubes=align_cubes.cl
task make_cube=make_cube.cl
task ifuproc_gqecorr=mygmos$ifuproc_gqecorr.cl

$task $pqecorr="$foreign"   # if executing python script in qecorr from iraf, else use the execute command below
pyexecute('mygmos$pqecorr_iraf.py')

# Set one-off parameters reproducibly:
gfreduce.rawpath="rawdir$"
gfreduce.bias="gN20051204S0227_bias.fits"
gfreduce.bpmfile="gmos$data/chipgaps.dat"
gfreduce.fl_fluxcal=no
gfreduce.fl_gscrrej=no
gfreduce.slits="both"

gfreduce.fl_inter=no
gfreduce.fl_vardq=yes
gfreduce.fl_addmdf=no
gfreduce.fl_over=no
gfreduce.fl_trim=no
gfreduce.fl_bias=no
gfreduce.fl_gscrrej=no
gfreduce.fl_skysub=no
gfreduce.fl_fluxcal=no
gfreduce.fl_fixgaps=yes
gfreduce.rawpath="rawdir$"
gfreduce.grow=1.5
#gfreduce.function="spline3" # default is chebyshev
#gfreduce.t_order=21
#gfreduce.weights="varience"

## Use bpms for the appropriate binning, mbpm is created from the others
ifuproc.mbpm="gn_bpm2x1m.fits"
ifuproc.bpm1="mygmos$bpms/gn_bpm_ccd1_2x1f.pl"
ifuproc.bpm2="mygmos$bpms/gn_bpm_ccd2_2x1f.pl"
ifuproc.bpm3="mygmos$bpms/gn_bpm_ccd3_2x1f.pl"
ifuproc.weights="none"
ifuproc.bpmgaps="gmos$data/chipgaps.dat"
## Width of chip gap and feature width
## Defaults are for 1x1 binning, this data is 2x1
ifuproc.gap12=19
ifuproc.gap23=19
ifuproc.fwidth=2.

## Use bpms for the appropriate binning, mbpm is created from the others
ifuproc_gqecorr.mbpm="gn_bpm2x1m.fits"
ifuproc_gqecorr.bpm1="mygmos$bpms/gn_bpm_ccd1_2x1f.pl"
ifuproc_gqecorr.bpm2="mygmos$bpms/gn_bpm_ccd2_2x1f.pl"
ifuproc_gqecorr.bpm3="mygmos$bpms/gn_bpm_ccd3_2x1f.pl"
ifuproc_gqecorr.weights="none"
ifuproc_gqecorr.bpmgaps="gmos$data/chipgaps.dat"
## Width of chip gap and feature width
## Defaults are for 1x1 binning, this data is 2x1
ifuproc_gqecorr.gap12=19
ifuproc_gqecorr.gap23=19
ifuproc_gqecorr.fwidth=2.


# Notes:
# ------
# ifuproc seems to work best in pyraf, gftransform can make multiple extensions in iraf
# make sure to change the task definition above depending on environment


# ---------------------
# Preliminary reduction
# ---------------------

## This step includes all the commands necessary to reduce the data, but not all steps are automated.
## The main task not automated is the veolcity shift correction. It is still required to interactively determine
##     the velocity shift based on the two arcs, and to correct the data in the opposite way to the arcs.
## Tasks which have been run previously have been commented out with a single #

    # Prepare the bias, twilights, flux standars, and science images
    # --------------------------------------------------------------
        #### gbais needs to be run in pyraf apparently ?? otherwise exslits param error
        ## Biases - combine
            #gemlist N20051204S 227-231 > bias.lis
            #gbias @bias.lis gN20051204S0227_bias.fits rawpath=rawdir$ fl_vardq+
            #gemlist N20051220S 228-232 > bias20.lis
            #gbias @bias20.lis gN20051220S0228_bias.fits rawpath=rawdir$ fl_vardq+

        ## Twilight - bias subtract
            #gemlist N20051203S 239-241 > twi.lis
            #gfreduce @twi.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
            #    fl_addmdf+ bias=gN20051204S0227_bias.fits

        ## Flux standards - bias subtract
            #gemlist N20051206S 133,134,135,138 > dec06.lis
            #gfreduce @dec06.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
            #    fl_addmdf+ bias=gN20051204S0227_bias.fits

        ## GALAXY science images - bias subtract
            #gemlist N20051205S 5-8 > dec05.lis
            #gfreduce @dec05.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
            #    fl_addmdf+ bias=gN20051204S0227_bias.fits

            #gemlist N20051222S 106-114 > dec22.lis
            #gfreduce @dec22.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
            #    fl_addmdf+ bias=gN20051204S0227_bias.fits
                # should be using bias 228 according to gwen

            #gemlist N20051223S 119-122 > dec23.lis
            #gfreduce @dec23.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
            #    fl_addmdf+ bias=gN20051220S0228_bias.fits



    # Process the standards, Hiltner600
    # ---------------------------------

        ##### here gwen processes rgN20051206S0133 first, then rgN20051206S0134
        ##### gwen: twilight=rgN20051203S0240.fits fl_inter- bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecor+ \
        ##        mbpm="gn_bpm2x1m.fits" bpm1=caldir$gn_ccd1_bpm2x1f.pl bpm2=caldir$gn_bpm_ccd2_2x1f.pl bpm3=caldir$gn_bpm_ccd3_2x1f.pl \
        ##        gap12=19 gap23=19 weights=none bpmgaps=gmos$data/chipgaps.dat fwidth=2. dw=.91 nw=1301 w1=4186
        #### in ifuproc: twilight different, bkgmask different, flcrspec on \
        ##        all the same \
        ##        dw not set default if INDEF, nw not set default INDEF, w1 not set default INDEF
        ## inputs: image, flat(s), arc(s)

        #ifuproc rgN20051206S0134 rgN20051206S0135 rgN20051206S0138 twilight=rgN20051203S0239 fl_inter=no \
        #    bkgmask=s0135_blkreg.dat fl_crspec=no fl_qecorr=yes

        #ifuproc_gqecorr rgN20051206S0134 rgN20051206S0135 rgN20051206S0138 twilight=rgN20051203S0239 fl_inter=no \
        #    bkgmask=s0135_blkreg.dat fl_crspec=no fl_qecorr=yes


        #### not sure if necessary, gwen puts through a twilight? from dec03
        ##ifuproc rgN20051203S0240 rgN20051203S0244 rgN20051203S0245 twilight=rgN20051203S0239 fl_inter- \
        ##    bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+
        #### gwen also proceses the second standard, but not used anywhere ???
        ##ifuproc rgN20051203S0133 rgN20051203S0135 rgN20051203S0138 twilight=rgN20051203S0240 fl_inter- \
        ##    bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+

        ## Visually confirm proper reconstructed spectra
            gfdisplay steqxbrgN20051206S0134.fits ver=1 z1=0 z2=1.e8

        ## Sum all the spectra
            #### here gwen also does this for: slqtexbrgN20051206S0133.fits outimages="" expr="default" fl_inter-
            #### then combines the two images: gscombine aslqtexbrgN20051206S0133.fits,aslqtexbrgN20051206S0134.fits \
            ##        Hiltner600_20051206.fits logfile="gmos.log" combine="average" scale="mean" sample="4550:4850" fl_vard-

            gfapsum steqxbrgN20051206S0134.fits

        ## Establish  spectrophotometric  calibration  for GMOS spectra
            ## correction curve should always be made interactively - avoid regions with strong absorption lines by using keystroke
            ##       commands to delete and add boxes away from the absorption lines
            ##   a: adds new bandpass, aa: make a box, d: deletes boxes closest to cusur, q: quit
            #### here gwen does this for the combined statdards: gsstandard Hiltner600_20051206.fits fl_inter+ sfile="std" sfunction="sens" \
            ##       starnam="h600" caldir="onedstds$ctionewcal/" observa="Gemini-North" extinct="gmos$calib/mkoextinct.dat"

            gsstandard asteqxbrgN20051206S0134.fits starname=h600 caldir=onedstds$ctionewcal/ extinction=gmos$calib/mkoextinct.dat fl_inter-


    # Measure velocity difference between the two output slits using arcs - only done once
    # -------------------------------------------------------------------

        #### could do for all arcs and calculate average shift as done by gwen
        ## We have found small pixel offsets between the two pseudo slits that are not removed by the wavelength calibration.
        ## The reason for this is not understood but here is one workaround using the arc to determine the shift and then
        ## applying it to the science data.
        ##gftransform ergN20051205S0008.fits wavtraname=ergN20051205S0008
        ##gfxcor tergN20051205S0008.fits obs=Gemini-North
        ##tselect tergN20051205S0008.fits[mdf] slit1.fits "NO <= 750"
        ##tselect tergN20051205S0008.fits[mdf] slit2.fits "NO >= 751"
        ##tstat slit1.fits,slit2.fits SHIFT lowlim=-1000.0 highlim=1000.
        ## slit1.fits  SHIFT
        ##  749     0.01689319103      0.019838         0.012        -0.023         0.112
        ## slit2.fits  SHIFT
        ##  747      0.1320923696     0.0360886         0.134         0.034         0.204
        ##=0.132-0.017
        ##0.115
        #### calculate the shift - subtract the difference with gfshit and confirm the new shift ~0
        ##gfshift tergN20051205S0008.fits stergN20051205S0008.fits shift2=-0.115
        #3gfxcor stergN20051205S0008.fits obs=Gemini-North
        ##delete slit?.fits
        ##tselect stergN20051205S0008.fits[mdf] slit1.fits "NO <= 750"
        ##tselect stergN20051205S0008.fits[mdf] slit2.fits "NO >= 751"
        ##tstat slit1.fits,slit2.fits SHIFT lowlim=-1000.0 highlim=1000.
        ## slit1.fits  SHIFT
        ##  749     0.01689319103      0.019838         0.012        -0.023         0.112
        ## slit2.fits  SHIFT
        ##  747     0.02548995992     0.0365223         0.028        -0.073         0.098


    # Process the science
    # -------------------

        ## Dec 05 - N20051205S0006, shift=-0.115

            ## Ifuproc - with one arc only, central wavelength is 478 so flat is 240
            #### here gwen also does this with both arcs ************* is this necessary?
            ifuproc_gqecorr rgN20051205S0006 rgN20051205S0007 rgN20051205S0008 twilight=rgN20051203S0240 fl_inter- \
                bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub-

            ## visually inspect reconstructed image
            gfdisplay qtexbrgN20051205S0006.fits ver=1 z2=1.e8

            ## Correct volocity difference between two output slits
            gfshift qtexbrgN20051205S0006.fits hqtexbrgN20051205S0006.fits shift2=-0.115

            ## Sky subtraction
            #### gwen uses "expr='XINST>10'" ****** necessary?
            gfskysub hqtexbrgN20051205S0006.fits fl_inter-

            ## Calibrate and visually inspect
            gscalibrate shqtexbrgN20051205S0006.fits extinction=gmos$calib/mkoextinct.dat fl_ext+ fl_vardq+

            gfdispl cshqtexbrgN20051205S0006.fits ver=1 z2=500


        ## Dec 22 - N20051222S0180 shift=-0.1042, N20051222S0112 shift=-0.1082

            ifuproc rgN20051222S0108 rgN20051222S0107 rgN20051222S0109 twilight=rgN20051203S0241 fl_inter- \
                bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub-
            gfdisplay qtexbrgN20051222S0180.fits ver=1 z2=1.e8
            gfshift qtexbrgN20051222S0180.fits hqtexbrgN20051222S0180.fits shift2=-0.1042
            gfskysub hqtexbrgN20051222S0180.fits fl_inter-
            gscalibrate shqtexbrgN20051222S0180.fits extinction=gmos$calib/mkoextinct.dat fl_ext+ fl_vardq+
            gfdisplay cshqtexbrgN20051222S0180.fits ver=1 z2=500

            ifuproc rgN20051222S0112 rgN20051222S0113 rgN20051222S0111 twilight=rgN20051203S0240 fl_inter- \
                bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub-
            gfdisplay qtexbrgN20051222S0112.fits ver=1 z2=1.e8
            gfshift qtexbrgN20051222S0112.fits hqtexbrgN20051222S0112.fits shift2=-0.1082
            gfskysub hqtexbrgN20051222S0112.fits fl_inter-
            gscalibrate shqtexbrgN20051222S0112.fits extinction=gmos$calib/mkoextinct.dat fl_ext+ fl_vardq+
            gfdisplay cshqtexbrgN20051222S0112.fits ver=1 z2=500

        ## Dec 23 - N20051223S0121 shift=-0.1047

            ifuproc rgN20051223S0121 rgN20051223S0120 rgN20051223S0122 twilight=rgN20051203S0241 fl_inter- \
                bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub-
            gfdisplay qtexbrgN20051223S0121.fits ver=1 z2=1.e8
            gfshift qtexbrgN20051223S0121.fits hqtexbrgN20051223S0121.fits shift2=-0.1047
            gfskysub hqtexbrgN20051223S0121.fits fl_inter-
            gscalibrate shqtexbrgN20051223S0121.fits extinction=gmos$calib/mkoextinct.dat fl_ext+ fl_vardq+
            gfdisplay cshqtexbrgN20051223S0121.fits ver=1 z2=500


## ---------------------------------
## Reorganise the data into 3D cubes
## ---------------------------------

## This is achieved with the task call 'call_cube.cl' which takes input (original file name, file extension number)

    #make_cube ("N20051205S0006.fits", 006)
    #make_cube ("N20051222S0108.fits", 108)
    #make_cube ("N20051222S0112.fits", 112)
    #make_cube ("N20051223S0121.fits", 122)


## -------------------------
## Shift and align the cubes
## -------------------------

## The output of this program is the fully shifted and combines cube - with both integer and decimal shifts.
## You may want to consider at this point cropping the final cubes in the spatial plane to remove the blank
##    sections added in the shift.

    ## Make temporary folders to organise output - only if it does not exist already
    #mkdir tmp_cal/

    #align_cubes ("N20051205S0006", "006")
    #align_cubes ("N20051222S0108", "108")
    #align_cubes ("N20051222S0112", "112")
    #align_cubes ("N20051223S0121", "122")

## To make 2D 'maps' fo the galaxy - use scrop to obtain a cube within the desired wavelength range, and then use
##    imcombine with 'project=yes' to flatten the cube inta a 2D image.