# Origanlly written by Bryan Miller and reduction steps by Gwen Rudie
# Edited by Kristi Webb May 2015

## 2005dec03
#GN-2005B-DD-5-3    16:20:39    1            239           Twilight               g        B600/478.0  IFU             300            full
#GN-2005B-DD-5-3    not quite enough counts, redo junk
#GN-2005B-DD-5-3    16:29:20    2            240           Twilight               g        B600/478.0  IFU             400            full
#GN-2005B-DD-5-3    35000 cts max ok
#GN-2005B-DD-5-3    16:38:00    3            241           Twilight               g        B600/482    IFU             120            full

## 2005dec04
#GN-CAL20051204-3  16:56:25    11-15        227-231       Bias         none     mirror     none  0.0            full

## 2005dec05
#GN-2005B-DD-5-2   04:28:42    1            1             IC225        g        mirror      none            10.0           ccd2
#GN-2005B-DD-5-2   p=27.6 q=-2.01
#GN-2005B-DD-5-2   04:33:08    2            2             IC225        g        mirror      IFU             60             full
#GN-2005B-DD-5-2   p=0.875, q=-0.33
#GN-2005B-DD-5-2   04:39:37    3            3             IC225        g        mirror      IFU             60             full
#GN-2005B-DD-5-2   centered on the midpoint btw the 2 nuclei
#GN-2005B-DD-5-1   04:43:50    1-2          4-5           CuAr         g        B600/478.0  IFU             120.0          full
#GN-2005B-DD-5-1   Junk
#GN-2005B-DD-5-1   04:52:05    3            6             IC225        g        B600/478.0  IFU             3300.0         full
#GN-2005B-DD-5-1   ok
#GN-2005B-DD-5-1   05:49:52    4            7             GCALflat     g        B600/478.0  IFU             40.0           full
#GN-2005B-DD-5-1   ok
#GN-2005B-DD-5-1   05:52:12    5            8             CuAr         g        B600/478.0  IFU             120.0          full
#GN-2005B-DD-5-1   ok

## 2005dec06
#GN-2005B-DD-5-4            11:51:59    1            124           Hiltner600   g        mirror      none  1              ccd2
#   testing seeing (unable to guide with guide star, switched to the brighter target for test)
#   ok
#GN-2005B-DD-5-4            11:55:34    2-3          125-126       Hiltner600   g        mirror      none  10             ccd2
#   ok
#   starting acquistion (guiding on correct star)
#GN-2005B-DD-5-4            12:05:49    4            127           Hiltner600   g        mirror      IFU   2              full
#   ok
#GN-2005B-DD-5-4            12:12:00    5-7          128-130       Hiltner600   g        mirror      IFU   2              full
#   ok
#   do not see  lower fiber bundle, but have centered star
#GN-2005B-DD-5-5            12:21:23    1-2          131-132       Hiltner600   g        B600/478.0  IFU   160.0          full
#   junk, lost guiding
#   ok, exptime 160
#GN-2005B-DD-5-5            12:36:39    3            133           Hiltner600   g        B600/478.0  IFU   300            full
#   ok, exptime 300
#GN-2005B-DD-5-5            12:46:42    4            134           Hiltner600   g        B600/478.0  IFU   400            full
#   ok, exptime 400
#GN-2005B-DD-5-5            12:56:10    5            135           GCALflat     g        B600/478.0  IFU   40.0           full
#   ok
#GN-2005B-DD-5-6            13:23:30    1            136           Hiltner600   g        mirror      none  10             ccd2
#   ok
#GN-2005B-DD-5-5            14:37:12    6            138           CuAr         g        B600/478.0  IFU   120.0          full
#   ok

## 2005dec20
#GN-CAL20051220-6  16:36:44    11-15        228-232       Bias         none     mirror     none  0.0            full

## 2005dec22
#GN-2005B-DD-5-2   06:42:26    4            103           IC225        g        mirror      none       10.0           ccd2
#GN-2005B-DD-5-2   06:51:19    5            104           IC225        g        mirror      IFU        60             full
#GN-2005B-DD-5-2   06:55:33    6            105           IC225        g        mirror      IFU        60             full
#GN-2005B-DD-5-1   06:59:30    6            106           CuAr         g        B600/482.0  IFU        120.0          full
#GN-2005B-DD-5-1   07:02:58    7            107           GCALflat     g        B600/482.0  IFU        40.0           full
#GN-2005B-DD-5-1   07:05:16    8            108           IC225        g        B600/482.0  IFU        3300.0         full
#GN-2005B-DD-5-1   08:01:54    9            109           CuAr         g        B600/482.0  IFU        120.0          full
#GN-2005B-DD-5-1   08:05:36    10-11        110-111       CuAr         g        B600/478.0  IFU        120.0          full
#GN-2005B-DD-5-1   08:12:35    12           112           IC225        g        B600/478.0  IFU        3300.0         full
#GN-2005B-DD-5-1   09:09:13    13           113           GCALflat     g        B600/478.0  IFU        40.0           full
#GN-2005B-DD-5-1   09:11:21    14           114           CuAr         g        B600/478.0  IFU        120.0          full

## 2005dec23
#GN-2005B-DD-5-2  06:42:20    7            116           IC225        g        mirror     none  10.0           ccd2
#GN-2005B-DD-5-2  06:57:01    8            117           IC225        g        mirror     IFU   60             full
#GN-2005B-DD-5-2  07:02:47    9            118           IC225        g        mirror     IFU   60             full

##Entries for images 119-122 missing, added manually from headers
#GN-2005B-DD-5-1   07:07:36    15            119           CuAr         g        B600/482.0  IFU        120.0          full
#GN-2005B-DD-5-1   07:11:04    16            120           GCALflat     g        B600/482.0  IFU        40.0           full
#GN-2005B-DD-5-1   07:13:23    17            121           IC225        g        B600/482.0  IFU        3300.0         full
#GN-2005B-DD-5-1   08:10:01    18            122           CuAr         g        B600/482.0  IFU        120.0          full

## Aliases
## -------
set dd5=/Users/kwebb/IFU_reduction/proc
set caldir=dd5$calib/
set rawdir=/net/sbfmaps/Volumes/Science/bmiller/bdisk/bmiller/GN-2005B-DD-5/raw/

set mygmos=/Users/kwebb/iraf/scripts/gmos/
#set gwengmos=/Users/kwebb/iraf/scripts/gwen/
set mypyfu=/Users/kwebb/iraf/extern/pyfu-0.8.1/
set jgmos=/Users/kwebb/iraf/extern/ifudrgmos/gmos/
set jpy=/Users/kwebb/iraf/extern/pyfu-0.8.1/
directory.nc=1
set stdimage=imtgmos

## Scripts
## -------
rv
onedspec
gemini
nmisc
gmos
pyfu

#task gscrspec=mygmos$gscrspec.cl
#task specx2w=mygmos$specx2w.cl             # not required
#task wrbox=mygmos$wrbox.cl
#task gspecshift=mygmos$gspecshift.cl
#task findgaps=mygmos$findgaps.cl
#task fndblocks=mygmos$fndblocks.cl
#task qecorr=mygmos$qecorr.cl
#task ifuproc=mygmos$ifuproc.cl
#task gfreduce=mygmos$gfreduce.cl           # USE STANDARD
#task gfextract=mygmos$gfextract.cl         # USE STANDARD
#task gftransform=mygmos$gftransform.cl      # to run in pyraf use nonstandard
#task gfresponse=mygmos$gfresponse.cl
#task gfskysub=mygmos$gfskysub.cl
#task gfbkgsub=mygmos$gfbkgsub.cl
#task gfdisplay=gmos$gfdisplay.cl
#task gscalibrate=mygmos$gscalibrate.cl
#task chkblocks=mygmos$chkblocks.cl

## James' scripts
task gbias=jgmos$gbias.cl
task gfapsum=jgmos$gfapsum.cl
task gfextract=jgmos$gfextract.cl
task gffindblocks=jgmos$gffindblocks.cl
task gfreduce=jgmos$gfreduce.cl
#task gfresponse=jgmos$gfresponse.cl        # can't figure out how to use, needs wavtraname
task gfscatsub=jgmos$gfscatsub.cl
task gfskysub=jgmos$gfskysub.cl
task gftransform=jgmos$gftransform.cl
task gfuntransform=jgmos$gfuntransform.par
task gmosaic=jgmos$gmosaic.cl
task gprepare=jgmos$gprepare.cl
task gqecorr=jgmos$gqecorr.cl
task gsappwave=jgmos$gsappwave.cl
task gscalibrate=jgmos$gscalibrate.cl
task gscrrej=jgmos$gscrrej.cl
task gsscatsub=jgmos$gsscatsub.cl
task gsstandard=jgmos$gsstandard.cl

#task gfextract=mygmos$gfextract_gsigma.c
task mkmbpm=mygmos$mkmbpm.cl                # no standard
task gfshift=mygmos$gfshift.cl              # no standard
task gkeywpars=mygmos$gkeywpars.cl
task gfxcor=mygmos$gfxcor.cl

#task gscombine=gwengmos$gscombine.cl          # adapted from standard, use this version
task gscombine=/Users/kwebb/iraf/scripts/gwen/gscombine.cl
task align_cubes=align_cubes.cl
task make_cube=make_cube.cl

task ifuproc_gqecorr=mygmos$ifuproc_gqecorr.cl
#task ifuproc_gwen=mygmos$ifuproc_gwen.cl
#task $pqecorr="$foreign"                   # execute in iraf
#pyexecute('mygmos$pqecorr_iraf.py')         # execute in pyraf

#pyexecute('jpy$pyfalign.par')
#pyexecute('jpy$pyfmosaic.py')
#pyexecute('jpy$pyflogbin.py')

# Set one-off parameters reproducibly:
gfreduce.slits="both"
#gfreduce.exslits="*"
gfreduce.fl_nodshuffl=no
gfreduce.fl_inter=no
gfreduce.fl_vardq=yes
gfreduce.fl_addmdf=no
gfreduce.fl_over=no
gfreduce.fl_trim=no
gfreduce.fl_bias=no
#gfreduce.fl_qecorr=no                      # not yet implemented
gfreduce.fl_gscrrej=no
gfreduce.fl_gnsskysub=no
gfreduce.fl_extract=yes
gfreduce.fl_gsappwave=yes
gfreduce.fl_wavtran=yes
gfreduce.fl_skysub=no
gfreduce.fl_fluxcal=no
gfreduce.rawpath="rawdir$"
gfreduce.key_mdf=""
gfreduce.mdffile="default"
gfreduce.mdfdir="gmos$data/"
gfreduce.key_biassec="BIASSEC"
gfreduce.key_datasec="DATASEC"
gfreduce.bpmfile="gmos$data/chipgaps.dat"
gfreduce.low_rej=3
gfreduce.high_rej=3
gfreduce.niter=5
gfreduce.bias="gN20051204S0227_bias.fits"
gfreduce.reference=""
#gfreduce.qe_refim=""
gfreduce.response=""                        # Don't use this; do our own flat fielding
gfreduce.wavtraname=""
gfreduce.sfunction=""
gfreduce.extinction=""
gfreduce.fl_novlap=yes
gfreduce.perovlap=10.0                      # 5 gives some contamination here
gfreduce.nbiascontam="default"
gfreduce.biasrows="3:64"
gfreduce.order=1
gfreduce.low_rej=3.0
gfreduce.high_rej=3.0
gfreduce.niter=5
gfreduce.line=INDEF
gfreduce.nsum=10
gfreduce.trace=yes
gfreduce.recenter=yes
gfreduce.thresh=200.
gfreduce.t_order=21
gfreduce.t_nsum=10
gfreduce.gratingdb="gmos$data/GMOSgratings.dat"
gfreduce.filterdb="gmos$data/GMOSfilters.dat"
gfreduce.xoffset=INDEF
gfreduce.expr="default"
gfreduce.observatory="default"
gfreduce.logfile=""
gfreduce.verbose=yes

# Parameter's that James uses
gfreduce.function="spline3"                 # defulat: chebyshev
gfreduce.order=1                            # defulat: 5
gfreduce.weights="none"                     # defulat: variance
gfreduce.grow=1.5                           # defulat: 1
gfreduce.fl_fixgaps=yes                     # defulat: no

gbias.logfile=""
gbias.rawpath="rawdir$"
gbias.fl_over=yes
gbias.fl_trim=yes
gbias.key_biassec="BIASSEC"
gbias.key_datasec="DATASEC"
gbias.bpm=""
gbias.sat="default"
gbias.nbiascontam="default"
gbias.biasrows="default"
gbias.fl_inter=yes
gbias.median=no
gbias.function="chebyshev"
gbias.order=1
gbias.low_reject=2.0                        # overscan
gbias.high_reject=2.0
gbias.order=1
gbias.niter=11
gbias.combine="average"
gbias.reject="avsigclip"
gbias.lthreshold=INDEF
gbias.hthreshold=INDEF
gbias.masktype="goodvalue"
gbias.maskvalue=0.0
gbias.scale="none"
gbias.zero="none"
gbias.weight="none"
gbias.statsec="[*,*]"
gbias.mclip=yes
gbias.lsigma=2.0                            # combine
gbias.hsigma=2.0
gbias.fl_vardq=yes
gbias.verbose=yes

gswavelength.dispaxis=1
#gswavelength.coordlist="IFU_example_data/cuar.dat"
gswavelength.section="middle line"
gswavelength.nsum=1
gswavelength.ftype="emission"
gswavelength.fwidth=10.0
gswavelength.gsigma=0.0
gswavelength.cradius=10.0
gswavelength.nlost=10
gswavelength.minsep=2.5
gswavelength.refit=yes
gswavelength.step=1
gswavelength.trace=yes
gswavelength.low_rej=2.5
gswavelength.high_rej=2.5
gswavelength.fl_addfeat=yes
gswavelength.aiddebug="s"
gswavelength.fl_dbwrite="YES"
gswavelength.fl_overwrite=yes

gfscatsub.outimage=""
gfscatsub.prefix="b"
gfscatsub.xorder="5,9,5"                    # try 5,5,9,5,5,5 for new GMOS-N CCDs
gfscatsub.yorder="5,7,5"                    # try 5,5,9,5,5,5 for new GMOS-N CCDs
gfscatsub.cross=yes

# Mainly defaults for the record, not set by gfreduce
gemcrspec.xorder=9
gemcrspec.yorder=-1
gemcrspec.sigclip=4.5                       # Sometimes needs changing for higher-contrast data
gemcrspec.sigfrac=0.32                      # 1.4 sigma is 84%
gemcrspec.objlim=1.0
gemcrspec.niter=5
gemcrspec.fl_vardq=yes
gemcrspec.logfile="example.log"
gemcrspec.verbose=yes

gfskysub.outimages=""
gfskysub.outpref="s"
gfskysub.expr="default"                     # same as gfreduce default
gfskysub.combine="average"
gfskysub.reject="avsigclip"
gfskysub.scale="none"
gfskysub.zero="none"
gfskysub.weight="none"
gfskysub.lthreshold=INDEF
gfskysub.hthreshold=INDEF
gfskysub.lsigma=3.0
gfskysub.hsigma=3.0
gfskysub.fl_inter=no

#rvidlines.observatory="gemini-north"       # remember to change throughout for GN!
rvidlines.nsum=1
rvidlines.maxfeatures=10
rvidlines.ftype="emission"
rvidlines.fwidth=10.
rvidlines.cradius=10.
rvidlines.threshold=10.
rvidlines.minsep=5.
rvidlines.logfile="rvid.log"

gemfix.grow=1.5
gemfix.bitmask=65535
gemfix.axis=1
gemfix.order=0
gemfix.low_reject=3.0
gemfix.high_reject=2.3
gemfix.niterate=5

gfextract.fl_vardq=yes

## Use bpms for the appropriate binning, mbpm is created from the others
#ifuproc.mbpm="gn_bpm2x1m.fits"
#ifuproc.bpm1="mygmos$bpms/gn_bpm_ccd1_2x1f.pl"
#ifuproc.bpm2="mygmos$bpms/gn_bpm_ccd2_2x1f.pl"
#ifuproc.bpm3="mygmos$bpms/gn_bpm_ccd3_2x1f.pl"
#ifuproc.weights="none"
#ifuproc.bpmgaps="gmos$data/chipgaps.dat"            # Width of chip gap and feature width, defaults are for 1x1 binning, this data is 2x1
#ifuproc.gap12=19
#ifuproc.gap23=19
#ifuproc.fwidth=2.

ifuproc_gqecorr.mbpm="gn_bpm2x1m.fits"
ifuproc_gqecorr.bpm1="mygmos$bpms/gn_bpm_ccd1_2x1f.pl"
ifuproc_gqecorr.bpm2="mygmos$bpms/gn_bpm_ccd2_2x1f.pl"
ifuproc_gqecorr.bpm3="mygmos$bpms/gn_bpm_ccd3_2x1f.pl"
ifuproc_gqecorr.weights="none"
ifuproc_gqecorr.bpmgaps="gmos$data/chipgaps.dat"    # Width of chip gap and feature width, defaults are for 1x1 binning, this data is 2x1
ifuproc_gqecorr.gap12=19
ifuproc_gqecorr.gap23=19
ifuproc_gqecorr.fwidth=2.

#ifuproc_gwen.mbpm="gn_bpm2x1m.fits"
#ifuproc_gwen.bpm1="mygmos$bpms/gn_bpm_ccd1_2x1f.pl"
#ifuproc_gwen.bpm2="mygmos$bpms/gn_bpm_ccd2_2x1f.pl"
#ifuproc_gwen.bpm3="mygmos$bpms/gn_bpm_ccd3_2x1f.pl"
#ifuproc_gwen.weights="none"
#ifuproc_gwen.bpmgaps="gmos$data/chipgaps.dat"    # Width of chip gap and feature width, defaults are for 1x1 binning, this data is 2x1
#ifuproc_gwen.gap12=19
#ifuproc_gwen.gap23=19
#ifuproc_gwen.fwidth=2.


# Notes:
# ------
# ifuproc seems to work best in pyraf, the standard gftransform however does not work here as theres an issue with avariable 'scilistout'
# make sure to change the task definition above depending on environment


# Preliminary reduction
# ---------------------

## This step includes all the commands necessary to reduce the data, but not all steps are automated.
## The main task not automated is the veolcity shift correction. It is still required to interactively determine
##     the velocity shift based on the two arcs, and to correct the data in the opposite way to the arcs.
## Tasks which have been run previously have been commented out with a single #

    # Prepare the bias, twilights, flux standars, and science images
    # --------------------------------------------------------------

        ## Biases - combine
#            gemlist N20051204S 227-231 > bias.lis
#            gbias @bias.lis gN20051204S0227_bias.fits rawpath=rawdir$ fl_vardq+
#            gemlist N20051220S 228-232 > bias20.lis
#            gbias @bias20.lis gN20051220S0228_bias.fits rawpath=rawdir$ fl_vardq+

        ## Twilight - bias subtract
#            gemlist N20051203S 239-241 > twi.lis
#            gfreduce @twi.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20051204S0227_bias.fits

       ## Flux standards - bias subtract
#            gemlist N20051206S 133,134,135,138 > dec06.lis
#            gfreduce @dec06.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20051204S0227_bias.fits

        ## GALAXY science images - bias subtract
#            gemlist N20051205S 5-8 > dec05.lis
#            gfreduce @dec05.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20051204S0227_bias.fits

#            gemlist N20051222S 106-114 > dec22.lis
#            gfreduce @dec22.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20051204S0227_bias.fits
                # should be using bias 228 according to gwen

#            gemlist N20051223S 119-122 > dec23.lis
#            gfreduce @dec23.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- fl_over+ fl_trim+ fl_vardq+ fl_bias+ \
#                fl_addmdf+ bias=gN20051220S0228_bias.fits


    # Process the standards, Hiltner600
    # ---------------------------------

        ## inputs: image, flat(s), arc(s)

#        ifuproc_gqecorr rgN20051206S0133 rgN20051206S0135 rgN20051206S0138 twilight=rgN20051203S0240 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec=no fl_qecorr=yes

#        ifuproc_gqecorr rgN20051206S0134 rgN20051206S0135 rgN20051206S0138 twilight=rgN20051203S0239 fl_inter=no \
#            bkgmask=s0135_blkreg.dat fl_crspec=no fl_qecorr=yes

        #### not sure if necessary, gwen puts through a twilight? from dec03
        ##ifuproc rgN20051203S0240 rgN20051203S0244 rgN20051203S0245 twilight=rgN20051203S0239 fl_inter- \
        ##    bkgmask=s0135_blkreg.dat fl_crspec- fl_qecorr+


        ## Visually confirm proper reconstructed spectra

#        gfdisplay steqpxbprgN20051206S0134.fits ver=1 z1=0 z2=1.e8

#        gfapsum steqpxbprgN20051206S0133.fits fl_inter-
#        gfapsum steqpxbprgN20051206S0134.fits fl_inter-

#        gscombine asteqpxbprgN20051206S0133.fits,asteqpxbprgN20051206S0134.fits hiltner600.fits logfile="gmos.log" \
#            combine="average" scale="mean" sample="4550:4850" fl_vardq-

        ## Establish  spectrophotometric  calibration  for GMOS spectra
            ## correction curve should always be made interactively - avoid regions with strong absorption lines by using keystroke
            ##       commands to delete and add boxes away from the absorption lines
            ##   a: adds new bandpass, aa: make a box, d: deletes boxes closest to cusuror, q: quit

#        gsstandard hiltner600.fits caldir="onedstds$ctionewcal/" observatory="Gemini-North" fl_inter+ \
#            extinction="gmos$calib/mkoextinct.dat" sfunction="sens_jamesiraf_new" sfile="std_jamesiraf_new" starname="h600"

#        splot sens_jamesiraf_new

    # Measure velocity difference between the two output slits using arcs - only done once
    # -------------------------------------------------------------------

        #### Calculate average shift  - as done by gwen
        ## We have found small pixel offsets between the two pseudo slits that are not removed by the wavelength calibration.
        ## The reason for this is not understood but here is one workaround using the arc to determine the shift and then
        ## applying it to the science data.

        #   gftransform ergN20051205S0008.fits wavtraname=ergN20051205S0008
        #   gfxcor tergN20051205S0008.fits obs=Gemini-North
        #   tselect tergN20051205S0008.fits[mdf] slit1.fits "NO <= 750"
        #   tselect tergN20051205S0008.fits[mdf] slit2.fits "NO >= 751"
        #   tstat slit1.fits,slit2.fits SHIFT lowlim=-1000.0 highlim=1000.

        ## slit1.fits  SHIFT
        ##  749     0.01689319103      0.019838         0.012        -0.023         0.112
        ## slit2.fits  SHIFT
        ##  747      0.1320923696     0.0360886         0.134         0.034         0.204
        ##=0.132-0.017
        ##0.115

        #### calculate the shift - subtract the difference with gfshit and confirm the new shift ~0
        #   gfshift tergN20051205S0008.fits stergN20051205S0008.fits shift2=-0.115
        #   gfxcor stergN20051205S0008.fits obs=Gemini-North
        #   delete slit?.fits
        #   tselect stergN20051205S0008.fits[mdf] slit1.fits "NO <= 750"
        #   tselect stergN20051205S0008.fits[mdf] slit2.fits "NO >= 751"
        #   tstat slit1.fits,slit2.fits SHIFT lowlim=-1000.0 highlim=1000.

        ## slit1.fits  SHIFT
        ##  749     0.01689319103      0.019838         0.012        -0.023         0.112
        ## slit2.fits  SHIFT
        ##  747     0.02548995992     0.0365223         0.028        -0.073         0.098


    # Process the science
    # -------------------

        ## Dec 05 - N20051205S0006, shift=-0.115

            ## Ifuproc - central wavelength is 478 so flat is 240

#            ifuproc_gqecorr rgN20051205S0006 rgN20051205S0007 rgN20051205S0008,rgN20051205S0005 twilight=rgN20051203S0240 fl_inter- \
#                bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub-

            ## visually inspect reconstructed image
#            gfdisplay steqpxbprgN20051205S0006.fits ver=1 z1=0 z2=1.e8

            ## Correct velocity difference between two output slits

            #--> tstat s0008_1.fits,s0008_2.fits SHIFT lowlim=-1000.0 highlim=1000.
            # nrows            mean        stddev        median           min           ma
            # s0008_1.fits  SHIFT
            #  749    0.006782376528     0.0197634         0.002        -0.028         0.118
            # s0008_2.fits  SHIFT
            #  747      0.1190950469     0.0349971         0.122         0.022         0.188
            # 0.1190950469 - 0.006782376528 = 0.112312670372

#            gfshift steqpxbprgN20051205S0006.fits hsteqpxbprgN20051205S0006.fits shift2=-0.112312670372

            ## Calibrate and visually inspect
#            gscalibrate steqpxbprgN20051205S0006.fits extinction=gmos$calib/mkoextinct.dat fl_ext+ fl_vardq+ sfunction="sens_jamesiraf_new"

#            gfdisplay csteqpxbprgN20051205S0006.fits ver=1 z2=500 z1=0

#### Note here the extrap 'p' to be added in

        ## Dec 22 - N20051222S0180 shift=-0.1042, N20051222S0112 shift=-0.1082

#            ifuproc_gqecorr rgN20051222S0108 rgN20051222S0107 rgN20051222S0109,rgN20051222S0114 twilight=rgN20051203S0241 fl_inter- \
#                bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub-
#            gfdisplay steqpxbprgN20051222S0108.fits ver=1 z2=1.e8
#            gfshift steqpxbprgN20051222S0108.fits hsteqpxbprgN20051222S0108.fits shift2=-0.1042
#            gscalibrate steqpxbprgN20051222S0108.fits extinction=gmos$calib/mkoextinct.dat fl_ext+ fl_vardq+ sfunction="sens_jamesiraf_new"
#            gfdisplay csteqpxbprgN20051222S0108.fits ver=1 z2=500

#            ifuproc_gqecorr rgN20051222S0112 rgN20051222S0113 rgN20051222S0111,,rgN20051222S0114 twilight=rgN20051203S0240 fl_inter- \
#                bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub-
#            gfdisplay steqpxbprgN20051222S0112.fits ver=1 z2=1.e8
#            gfshift steqpxbprgN20051222S0112.fits hsteqpxbprgN20051222S0112.fits shift2=-0.1082
#            gscalibrate steqpxbprgN20051222S0112.fits extinction=gmos$calib/mkoextinct.dat fl_ext+ fl_vardq+ sfunction="sens_jamesiraf_new"
#            gfdisplay csteqpxbprgN20051222S0112.fits ver=1 z2=500

        ## Dec 23 - N20051223S0121 shift=-0.1047

#            ifuproc_gqecorr rgN20051223S0121 rgN20051223S0120 rgN20051223S0122 twilight=rgN20051203S0241 fl_inter- \
#                bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub-
#            gfdisplay steqpxbprgN20051223S0121.fits ver=1 z2=1.e8
#            gfshift steqpxbprgN20051223S0121.fits hsteqpxbprgN20051223S0121.fits shift2=-0.1047
#            gscalibrate steqpxbprgN20051223S0121.fits extinction=gmos$calib/mkoextinct.dat fl_ext+ fl_vardq+ sfunction="sens_jamesiraf_new"
#            gfdisplay csteqpxbprgN20051223S0121.fits ver=1 z2=500



## Reorganise the data into 3D cubes
## ---------------------------------

#### SHOULD be using rvidlines to correct for any drifts in the wavelength zero point, since we're using
#### a day-time arc. NOT yet sure how this works.
    ## rvidlines.coordlist="skylines.dat"
    ## rvidlines steqpxbprgN20051205S0006.fits[sky] threshold=7.
    ## rvidlines steqpxbprgN20051222S0108.fits[sky] threshold=7.
    ## rvidlines steqpxbprgN20051222S0112.fits[sky] threshold=7.
    ## rvidlines steqpxbprgN20051223S0121.fits[sky] threshold=7.
#### Then, adjust the data prior to sky subtraction along with the final data to check how well the lines end up being registered.
#### CHANGE VALUES
    ## hedit teqpxbprgN20051205S0006.fits[sci] CRVAL1 5618.164 upd+ ver-
    ## hedit csteqpxbprgN20051205S0006.fits[sci] CRVAL1 5618.164 upd+ ver-
    ## hedit teqpxbprgN20051222S0108.fits[sci] CRVAL1 5618.164 upd+ ver-
    ## hedit csteqpxbprgN20051222S0108.fits[sci] CRVAL1 5618.164 upd+ ver-
    ## hedit teqpxbprgN20051222S0112.fits[sci] CRVAL1 5618.164 upd+ ver-
    ## hedit csteqpxbprgN20051222S0112.fits[sci] CRVAL1 5618.164 upd+ ver-
    ## hedit teqpxbprgN20051223S0121.fits[sci] CRVAL1 5618.164 upd+ ver-
    ## hedit csteqpxbprgN20051223S0121.fits[sci] CRVAL1 5618.164 upd+ ver-
#### Then, sum over the WCS-corrected spectra & overplot (manually) for comparison
    ## improj teqpxbprgN20051205S0006[sci] t0006_sum projax=2 average-
    ## improj teqpxbprgN20051222S0108[sci] t0108_sum projax=2 average-
    ## improj teqpxbprgN20051222S0112[sci] t0112_sum projax=2 average-
    ## improj teqpxbprgN20051223S0121[sci] t0121_sum projax=2 average-

    ## Resample to 3D with (minimal) atmospheric dispersion correction:
#    gfcube ("csteqpxbprgN20051205S0006.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("csteqpxbprgN20051222S0108.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("csteqpxbprgN20051222S0112.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("csteqpxbprgN20051223S0121.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)

    ## # Mosaic the datacubes:
    pyfalign dcsteqpxbprgN20051205S0006,dcsteqpxbprgN20051222S0108,dcsteqpxbprgN20051222S0112,dcsteqpxbprgN20051223S0121 method="correlate"
    pyfmosaic dcsteqpxbprgN20051205S0006,dcsteqpxbprgN20051222S0108,dcsteqpxbprgN20051222S0112,dcsteqpxbprgN20051223S0121 \
        dcsteqpxbprgN20051205S0006_add separate- var+

    ## Resample the final cube in log wavelength increments: (it shouldn't be that difficult now to build this step
    ## directly into pyfmosaic but I haven't done that yet)

    pyflogbin dcsteqpxbprgN20051205S0006_add ldcsteqpxbprgN20051205S0006_add var+

    ## Also make some cubes with sky lines included, to check for deterioration in FWHM after mosaicking:
#    gfcube ("teqpxbprgN20051205S0006.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("teqpxbprgN20051222S0108.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("teqpxbprgN20051222S0112.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("teqpxbprgN20051223S0121.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)


## CHANGE VALUES
    ## Give them the same offsets from pyfalign as the science cubes (after looking at the results from above):
#    hedit dchsteqpxbprgN20051205S0006[sci] CRVAL1 64.99041999992549 upd+ ver-
#    hedit dchsteqpxbprgN20051205S0006[sci] CRVAL2 0.04500000992549393 upd+ ver-
#    hedit dchsteqpxbprgN20051222S0108[sci] CRVAL1 64.99041999992549 upd+ ver-
#    hedit dchsteqpxbprgN20051222S0108[sci] CRVAL2 0.04500000992549393 upd+ ver-
#    hedit dchsteqpxbprgN20051222S0112[sci] CRVAL1 65.48042000722705 upd+ ver-
#    hedit dchsteqpxbprgN20051222S0112[sci] CRVAL2 0.04500000992549393 upd+ ver-
#    hedit dchsteqpxbprgN20051223S0121[sci] CRVAL1 65.47042000707805 upd+ ver-
#    hedit dchsteqpxbprgN20051223S0121[sci] CRVAL2 0.04500000992549393 upd+ ver-

    ## Mosaic the object + sky cubes: A quick imexam comparison with the first cube shows minimal if any
    ## degradation, with FWHM differences within 0.1-0.3 pix in both directions that look consistent with noise.
#    pyfmosaic dchsteqpxbprgN20051205S0006,dchsteqpxbprgN20051222S0108,dchsteqpxbprgN20051222S0112,dchsteqpxbprgN20051223S0121 \
#        dchsteqpxbprgN20051205S0006_add separate-


#### Gwen's scripts
# -----------------

#    gfcube ("csteqpxbprgN20051205S0006.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("csteqpxbprgN20051222S0108.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("csteqpxbprgN20051222S0112.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)
#    gfcube ("csteqpxbprgN20051223S0121.fits", fl_atm+, fl_flux+, fl_var+, fl_dq+)

    ## This is achieved with the task call 'call_cube.cl' which takes input (original file name, file extension number)

#    make_cube.prefix="steqpxbprg"
#    make_cube ("N20051205S0006.fits", 006)
#    make_cube ("N20051222S0108.fits", 108)
#    make_cube ("N20051222S0112.fits", 112)
#    make_cube ("N20051223S0121.fits", 122)

## The output of this program is the fully shifted and combines cube - with both integer and decimal shifts.
## You may want to consider at this point cropping the final cubes in the spatial plane to remove the blank
##    sections added in the shift.
    ## Make temporary folders to organise output - only if it does not exist already
#    mkdir tmp_cal
#    align_cubes ("N20051205S0006", "006")
#    align_cubes.prefix="hsteqpxbrg"         ## 'dc' prefix will be added in where appropriate
#    align_cubes ("N20051222S0108", "108")
#    align_cubes ("N20051222S0112", "112")
#    align_cubes ("N20051223S0121", "122")

## To make 2D 'maps' fo the galaxy - use scrop to obtain a cube within the desired wavelength range, and then use
##    imcombine with 'project=yes' to flatten the cube inta a 2D image.