# Edited Example IFU reduction (example written by Bryan Miller)
# Kristi Webb

# 2005dec03
#GN-2005B-DD-5-3    16:20:39    1            239           Twilight               g        B600/478.0  IFU             300            full   
#GN-2005B-DD-5-3    not quite enough counts, redo junk
#GN-2005B-DD-5-3    16:29:20    2            240           Twilight               g        B600/478.0  IFU             400            full   
#GN-2005B-DD-5-3    35000 cts max ok
#GN-2005B-DD-5-3    16:38:00    3            241           Twilight               g        B600/482    IFU             120            full   

# 2005dec04
#GN-CAL20051204-3  16:56:25    11-15        227-231       Bias         none     mirror     none  0.0            full   

# 2005dec05
#GN-2005B-DD-5-2   04:28:42    1            1             IC225        g        mirror      none            10.0           ccd2  
#GN-2005B-DD-5-2   p=27.6 q=-2.01
#GN-2005B-DD-5-2   04:33:08    2            2             IC225        g        mirror      IFU             60             full  
#GN-2005B-DD-5-2   p=0.875, q=-0.33
#GN-2005B-DD-5-2   04:39:37    3            3             IC225        g        mirror      IFU             60             full  
#GN-2005B-DD-5-2   centered on the midpoint btw the 2 nuclei
#GN-2005B-DD-5-1   04:43:50    1-2          4-5           CuAr         g        B600/478.0  IFU             120.0          full  
#GN-2005B-DD-5-1   Junk
#GN-2005B-DD-5-1   04:52:05    3            6             IC225        g        B600/478.0  IFU             3300.0         full  
#GN-2005B-DD-5-1   ok
#GN-2005B-DD-5-1   05:49:52    4            7             GCALflat     g        B600/478.0  IFU             40.0           full  
#GN-2005B-DD-5-1   ok
#GN-2005B-DD-5-1   05:52:12    5            8             CuAr         g        B600/478.0  IFU             120.0          full  
#GN-2005B-DD-5-1   ok

# 2005dec06
#GN-2005B-DD-5-4            11:51:59    1            124           Hiltner600   g        mirror      none  1              ccd2   
#GN-2005B-DD-5-4            testing seeing (unable to guide with guide star, switched to the brighter target for test)
#GN-2005B-DD-5-4            ok

#GN-2005B-DD-5-4            11:55:34    2-3          125-126       Hiltner600   g        mirror      none  10             ccd2   
#GN-2005B-DD-5-4            ok
#GN-2005B-DD-5-4-003       starting acquistion (guiding on correct star)

#GN-2005B-DD-5-4            12:05:49    4            127           Hiltner600   g        mirror      IFU   2              full   
#GN-2005B-DD-5-4            ok

#GN-2005B-DD-5-4            12:12:00    5-7          128-130       Hiltner600   g        mirror      IFU   2              full   
#GN-2005B-DD-5-4            ok
#GN-2005B-DD-5-4-007       do not see  lower fiber bundle, but have centered star

#GN-2005B-DD-5-5            12:21:23    1-2          131-132       Hiltner600   g        B600/478.0  IFU   160.0          full   
#GN-2005B-DD-5-5            junk, lost guiding
#GN-2005B-DD-5-5-002       ok, exptime 160

#GN-2005B-DD-5-5            12:36:39    3            133           Hiltner600   g        B600/478.0  IFU   300            full   
#GN-2005B-DD-5-5            ok, exptime 300

#GN-2005B-DD-5-5            12:46:42    4            134           Hiltner600   g        B600/478.0  IFU   400            full   
#GN-2005B-DD-5-5            ok, exptime 400

#GN-2005B-DD-5-5            12:56:10    5            135           GCALflat     g        B600/478.0  IFU   40.0           full   
#GN-2005B-DD-5-5            ok

#GN-2005B-DD-5-6            13:23:30    1            136           Hiltner600   g        mirror      none  10             ccd2   
#GN-2005B-DD-5-6            ok

#GN-2005B-DD-5-5            14:37:12    6            138           CuAr         g        B600/478.0  IFU   120.0          full   
#GN-2005B-DD-5-5            ok


# 2005dec20


#GN-CAL20051220-6  16:36:44    11-15        228-232       Bias         none     mirror     none  0.0            full


# 2005dec22


#GN-2005B-DD-5-2   06:42:26    4            103           IC225        g        mirror      none       10.0           ccd2

#GN-2005B-DD-5-2   06:51:19    5            104           IC225        g        mirror      IFU        60             full

#GN-2005B-DD-5-2   06:55:33    6            105           IC225        g        mirror      IFU        60             full

#GN-2005B-DD-5-1   06:59:30    6            106           CuAr         g        B600/482.0  IFU        120.0          full

#GN-2005B-DD-5-1   07:02:58    7            107           GCALflat     g        B600/482.0  IFU        40.0           full

#GN-2005B-DD-5-1   07:05:16    8            108           IC225        g        B600/482.0  IFU        3300.0         full

#GN-2005B-DD-5-1   08:01:54    9            109           CuAr         g        B600/482.0  IFU        120.0          full

#GN-2005B-DD-5-1   08:05:36    10-11        110-111       CuAr         g        B600/478.0  IFU        120.0          full

#GN-2005B-DD-5-1   08:12:35    12           112           IC225        g        B600/478.0  IFU        3300.0         full

#GN-2005B-DD-5-1   09:09:13    13           113           GCALflat     g        B600/478.0  IFU        40.0           full

#GN-2005B-DD-5-1   09:11:21    14           114           CuAr         g        B600/478.0  IFU        120.0          full


# 2005dec23


#GN-2005B-DD-5-2  06:42:20    7            116           IC225        g        mirror     none  10.0           ccd2

#GN-2005B-DD-5-2  06:57:01    8            117           IC225        g        mirror     IFU   60             full

#GN-2005B-DD-5-2  07:02:47    9            118           IC225        g        mirror     IFU   60             full

#Entries for images 119-122 missing, added manually from headers
#GN-2005B-DD-5-1   07:07:36    15            119           CuAr         g        B600/482.0  IFU        120.0          full

#GN-2005B-DD-5-1   07:11:04    16            120           GCALflat     g        B600/482.0  IFU        40.0           full

#GN-2005B-DD-5-1   07:13:23    17            121           IC225        g        B600/482.0  IFU        3300.0         full

#GN-2005B-DD-5-1   08:10:01    18            122           CuAr         g        B600/482.0  IFU        120.0          full

#Aliases
#-------
set dd5=/Users/kwebb/IFU_reduction/proc
set caldir=dd5$calib/
set rawdir=/net/sbfmaps/Volumes/Science/bmiller/bdisk/bmiller/GN-2005B-DD-5/raw/

set mygmos=/Users/kwebb/iraf/scripts/gmos/
#set mygmos=/data1/kwebb/gemini/iraf/scripts/gmos/      # oringal file structure, changed for MacOSX path names
directory.nc=1
 
#Scripts
#-------
onedspec
gemini
nmisc
#gemlocal   # not required
gmos
task gscrspec=mygmos$gscrspec.cl
#task specx2w=mygmos$specx2w.cl     # not required
task wrbox=mygmos$wrbox.cl
task gspecshift=mygmos$gspecshift.cl
task findgaps=mygmos$findgaps.cl
task fndblocks=mygmos$fndblocks.cl
task qecorr=mygmos$qecorr.cl
task ifuproc=mygmos$ifuproc.cl
task gfreduce=mygmos$gfreduce.cl
task gfextract=mygmos$gfextract.cl
task gftransform=mygmos$gftransform.cl     # to run in pyraf, uncomment, to run in iraf comment out
task gfresponse=mygmos$gfresponse.cl
task gfskysub=mygmos$gfskysub.cl
task gfbkgsub=mygmos$gfbkgsub.cl
task gfdisplay=mygmos$gfdisplay.cl
task gscombine=mygmos$gscombine.cl
task gscalibrate=mygmos$gscalibrate.cl
task chkblocks=mygmos$chkblocks.cl
task gkeywpars=mygmos$gkeywpars.cl
task gfshift=mygmos$gfshift.cl
task gfxcor=mygmos$gfxcor.cl
task mkmbpm=mygmos$mkmbpm.cl
rv

$task $pqecorr="$foreign"   # if executing python script in qecorr from iraf, else use the execute command below
pyexecute('mygmos$pqecorr_iraf.py')

# Set common parameter values
gfreduce.rawpath="rawdir$"
gfreduce.bias="gN20051204S0227_bias.fits"
gfreduce.bpmfile="gmos$data/chipgaps.dat"
gfreduce.fl_fluxcal=no
gfreduce.fl_gscrrej=no
gfreduce.slits="both"

# use bpms for the appropriate binning, mbpm is created from the others
ifuproc.mbpm="gn_bpm2x1m.fits"
ifuproc.bpm1="mygmos$bpms/gn_bpm_ccd1_2x1f.pl"
ifuproc.bpm2="mygmos$bpms/gn_bpm_ccd2_2x1f.pl"
ifuproc.bpm3="mygmos$bpms/gn_bpm_ccd3_2x1f.pl"
ifuproc.weights="none"
ifuproc.bpmgaps="gmos$data/chipgaps.dat"

# Width of chip gap and feature width
# Defaults are for 1x1 binning, this data is 2x1
ifuproc.gap12=19 
ifuproc.gap23=19 
ifuproc.fwidth=2.

#int l_input
#string l_input
#int l_shift
#string l_file


# PREPARE the bias, twilights, and flux standards once
# ------------------------------------------------------





# files should now have prefix rg*




# MEASURE VELOCITY DIFFERENCE between the two output slits using arcs - enter results into list below
# -------------------------------------------------------------------

#### could do for all arcs and calculate average shift as done by gwen
# We have found small pixel offsets between the two pseudo slits that are not removed by the wavelength calibration.
# The reason for this is not understood but here is one workaround using the arc to determine the shift and then
# applying it to the science data.
#gftransform ergN20051205S0008.fits wavtraname=ergN20051205S0008
#gfxcor tergN20051205S0008.fits obs=Gemini-North
#tselect tergN20051205S0008.fits[mdf] slit1.fits "NO <= 750"
#tselect tergN20051205S0008.fits[mdf] slit2.fits "NO >= 751"
#tstat slit1.fits,slit2.fits SHIFT lowlim=-1000.0 highlim=1000.
# slit1.fits  SHIFT
#  749     0.01689319103      0.019838         0.012        -0.023         0.112
# slit2.fits  SHIFT
#  747      0.1320923696     0.0360886         0.134         0.034         0.204
#=0.132-0.017
#0.115
#### calculate the shift - subtract the difference with gfshit and confirm the new shift ~0
#gfshift tergN20051205S0008.fits stergN20051205S0008.fits shift2=-0.115
#gfxcor stergN20051205S0008.fits obs=Gemini-North
#delete slit?.fits
#tselect stergN20051205S0008.fits[mdf] slit1.fits "NO <= 750"
#tselect stergN20051205S0008.fits[mdf] slit2.fits "NO >= 751"
#tstat slit1.fits,slit2.fits SHIFT lowlim=-1000.0 highlim=1000.
# slit1.fits  SHIFT
#  749     0.01689319103      0.019838         0.012        -0.023         0.112
# slit2.fits  SHIFT
#  747     0.02548995992     0.0365223         0.028        -0.073         0.098





# REPEAT FOR ALL SCIENCE FRAMES
# -----------------------------




#gemlist N20051222S 106-114 > dec22.lis
#imdel g@dec22.lis,rg@dec22.lis
#gfreduce @dec22.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- bias=gN20051204S0227_bias.fits

gemlist N20051223S 119-122 > dec23.lis
imdel g@dec23.lis,rg@dec23.lis
gfreduce @dec23.lis fl_extract- fl_gsappwave- fl_wavtran- fl_skysub- bias=gN20051220S0228_bias.fits

# IFUPROC - with one arc only, central wavelength is 478 so flat is 240 (cite gwen)
# ---------------------------

print ('>>>>> ifuproc')
#### here gwen also does this with both arcs ************* is this necessary?
#ifuproc rgN20051205S0006 rgN20051205S0007 rgN20051205S0008  twilight=rgN20051203S0240  fl_inter- bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub-
#ifuproc rgN20051205S0006 rgN20051205S0007 rgN20051205S0008 twilight=rgN20051203S0240 fl_inter- bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub-

print (' >>>>>>>>>>>> 1 down')
ifuproc rgN20051222S0108 rgN20051222S0107 rgN20051222S0109 twilight=rgN20051203S0240 fl_inter- bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub-

print ('>>>>> 2 down')
ifuproc rgN20051222S0112 rgN20051222S0113 rgN20051222S0111 twilight=rgN20051203S0240 fl_inter- bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub-
ifuproc rgN20051222S0121 rgN20051222S0120 rgN20051222S0122 twilight=rgN20051203S0241 fl_inter- bkgmask=s0007_blkreg.dat fl_crspec+ fl_qecorr+ fl_skysub-


#l_input[1] = 'N20051205S0006'
#l_input[2]='N20051222S0108'
#l_input[3]='N20051222S0112'
#l_input[4]='N20051223S0121'
#l_shift[1]=-0.115
#l_shift[2]=-0.1042
#l_shift[3]=-0.1082
#l_shift[4]=-0.1047
l_input='108'
l_shift=-0.1042



    # ITERATE THROUGH SCIENCE FRAMES
    # ------------------------------

    #for (i=1; i<=4; i+=1) {

    print('gets here')

    l_file = "rg"//l_input

    # visually inspect reconstructed image
    #gfdisplay qtexbrgN20051205S0006.fits ver=1 z2=1.e8
    gfdisplay ("qtexb"//l_file//".fits", ver=1, z2=1.e8)

    # CORRECT VELOCITY difference between two output slits
    #gfshift qtexbrgN20051205S0006.fits hqtexbrgN20051205S0006.fits shift2=-0.115
    gfshift ("qtexb"//l_file//".fits", "hqtexb"//l_file//".fits", shift2=l_shift)

    # SKY SUBtraction
    #### gwen uses "expr='XINST>10'" ****** necessary?
    #gfskysub hqtexbrgN20051205S0006.fits fl_inter-
    gfskysub ("hqtexb"//l_file//".fits", fl_inter-)

    # CALIBRATE and visually inspect
    #gscalibrate shqtexbrgN20051205S0006.fits extinction=gmos$calib/mkoextinct.dat fl_ext+ fl_vardq+
    gscalibrate ("shqtexb"//l_file//".fits", extinction=gmos$calib/mkoextinct.dat, fl_ext+, fl_vardq+)

    #gfdispl cshqtexbrgN20051205S0006.fits ver=1 z2=500
    gfdisplay ("cshqtexb"//l_file//".fits", ver=1, z2=500)


    #}